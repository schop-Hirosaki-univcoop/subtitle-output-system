<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>質問フォーム管理</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%2064%2064%27%3E%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2712%27%20fill%3D%2705111f%27%2F%3E%3Ctext%20x%3D%2732%27%20y%3D%2742%27%20text-anchor%3D%27middle%27%20font-family%3D%27Arial%2C%20sans-serif%27%20font-size%3D%2736%27%20fill%3D%2700eaff%27%3EM%3C%2Ftext%3E%3C%2Fsvg%3E">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../question-form.css">
  <script type="module" src="../scripts/shared/layout.js"></script>
  <script>
    (function () {
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.get("embed") === "1") {
          document.documentElement.classList.add("embedded-view");
          const apply = () => document.body && document.body.classList.add("embedded-view");
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", apply, { once: true });
          } else {
            apply();
          }
        }
      } catch (error) {
        console.warn("Failed to apply embedded view mode", error);
      }
    })();
  </script>
</head>
<body class="op-theme question-admin-page">
  <div id="loading-overlay" aria-live="polite" hidden>
    <div class="loading-backdrop"></div>
    <div class="loading-panel" role="status" aria-label="読み込み中">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text"><span id="loading-text">初期化中…</span></div>
      <div class="loading-sub">数秒かかる場合があります</div>
      <ol id="loader-steps" class="loader-steps" aria-label="初期化ステップ"></ol>
    </div>
  </div>
  <telop-header tagline="Question Form Admin" context-label="管理ページ情報">
    <div slot="meta" id="user-info" class="user-info" hidden aria-hidden="true"></div>
    <button slot="actions" id="header-logout" class="btn btn-ghost btn-sm" type="button" hidden>ログアウト</button>
  </telop-header>

  <main id="admin-main" class="admin-main" hidden>
    <section class="module module--primary admin-module" aria-labelledby="participant-title">
      <div class="module-header">
        <div class="module-heading">
          <h2 id="participant-title">参加者リストの管理</h2>
          <p class="module-description" id="participant-description">選択したイベント・日程の参加者情報を管理できます。各参加者ごとに質問フォームの専用リンクを発行でき、「編集」から詳細や班番号を更新できます。電話番号とメールアドレスは内部で管理され、編集時のみ確認できます。同じイベント内で名前と学部学科が一致する参加者は重複候補として件数付きで表示されます。専用リンクは各行のボタンまたはURLから取得できます。<span id="admin-summary" class="module-description__meta" aria-live="polite"></span></p>
        </div>
      </div>
      <div class="module-body">
        <p id="participant-context" class="admin-context">イベントコントロールセンターで指定した日程の参加者が表示されます。URL の <code>eventId</code> と <code>scheduleId</code> パラメーターを確認してください。</p>
      <div class="admin-controls">
        <div class="admin-controls__row admin-controls__row--imports">
            <button id="download-participant-template" class="btn btn-ghost btn-sm" type="button">参加者CSVテンプレのDL</button>
            <label class="btn btn-ghost file-input" for="csv-input">
              <span id="file-label">参加者CSVをアップロード</span>
              <input id="csv-input" type="file" accept=".csv,text/csv">
            </label>
            <button id="download-team-template" class="btn btn-ghost btn-sm" type="button" disabled>班番号CSVテンプレのDL</button>
            <label class="btn btn-ghost file-input" for="team-csv-input">
              <span id="team-file-label">班番号CSVをアップロード</span>
              <input id="team-csv-input" type="file" accept=".csv,text/csv">
            </label>
          </div>
          <div class="admin-controls__row admin-controls__row--actions">
            <button id="discard-button" class="btn btn-ghost btn-sm" type="button" disabled>取消</button>
            <button id="save-button" class="btn btn-primary" type="button" disabled>適用</button>
            <button id="clear-participants-button" class="btn btn-danger btn-sm" type="button" disabled>参加者リストを全削除</button>
            <span id="upload-status" class="status-pill status-pill--inline">イベントコントロールセンターで対象の日程を選択してください。</span>
          </div>
        </div>
        <div id="change-preview" class="change-preview" hidden aria-live="polite">
          <div class="change-preview__header">
            <span class="change-preview__title">未保存の変更があります</span>
            <span id="change-preview-count" class="change-preview__count"></span>
          </div>
          <ul id="change-preview-list" class="change-preview__list" aria-label="未保存の変更一覧"></ul>
          <p id="change-preview-note" class="change-preview__note">「適用」で変更を確定し、「取消」で破棄できます。</p>
        </div>
        <div class="participant-card-shell">
          <div id="participant-card-list" class="participant-card-list" role="list" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <section class="module module--secondary admin-module" aria-labelledby="format-title">
      <div class="module-header">
        <div class="module-heading">
          <h2 id="format-title">CSVの形式について</h2>
          <p class="module-description">ヘッダー行として、1列目から順に「名前」「フリガナ」「性別」「学部学科」「携帯電話」「メールアドレス」を配置してください。アップロード時には必ずヘッダー行が必要です。テンプレボタンからダウンロードできます。ファイル名は「イベントID_日程ID_participants.csv」を使用してください。電話番号とメールアドレスは内部で保存され、編集ダイアログでのみ確認できます。</p>
        </div>
      </div>
      <div class="module-body">
        <ul>
          <li>ヘッダー行が必須です。</li>
          <li>同じUIDや同じ氏名・学部学科の行が複数あっても全て読み込み、一覧上で重複候補として確認できます。</li>
          <li>CSVにNo.列は不要です。読み込み時に学部学科→フリガナの順で並べ替え、表示用のNo.は自動採番されます。</li>
          <li>同じイベント内で名前と学部学科が一致する参加者は重複候補として件数付きで表示されます。</li>
          <li>各列は空欄でもアップロードできますが、氏名は必須です。</li>
          <li>保存後はフォームに即座に反映されます。</li>
          <li>班番号は別途、<code>学部学科,性別,名前,班番号,uid</code>形式のCSV（ヘッダー必須）をアップロードすると一括で紐付けられます（「キャンセル」はキャンセル済み、「別日」は別日移動として扱われます）。テンプレートには現在のUIDがあらかじめ記載されます。ファイル名は「イベントID_日程ID_teams.csv」としてください。</li>
        </ul>
      </div>
    </section>
  </main>

  <div id="participant-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="participant-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <form id="participant-form">
        <div class="modal-header">
          <h2 id="participant-dialog-title">参加者情報を編集</h2>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label for="participant-name-input">氏名 / ラジオネーム</label>
            <input id="participant-name-input" name="participant-name" class="input" type="text" autocomplete="off" required>
          </div>
          <div class="modal-field">
            <label for="participant-phonetic-input">フリガナ</label>
            <input id="participant-phonetic-input" name="participant-phonetic" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-gender-input">性別</label>
            <input id="participant-gender-input" name="participant-gender" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-department-input">学部学科</label>
            <input id="participant-department-input" name="participant-department" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-team-input">班番号</label>
            <input id="participant-team-input" name="participant-team" class="input" type="text" autocomplete="off" placeholder="例: A-1 / キャンセル / 別日など">
          </div>
          <div id="participant-relocation-summary" class="modal-field" hidden>
            <div class="modal-label">別日への移動情報</div>
            <p id="participant-relocation-summary-text" class="modal-helper"></p>
          </div>
          <div class="modal-field">
            <label for="participant-phone-input">携帯電話</label>
            <input id="participant-phone-input" name="participant-phone" class="input" type="tel" autocomplete="tel">
          </div>
          <div class="modal-field">
            <label for="participant-email-input">メールアドレス</label>
            <input id="participant-email-input" name="participant-email" class="input" type="email" autocomplete="email">
          </div>
          <p id="participant-error" class="form-error" role="alert" hidden></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-dialog-dismiss="true">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <div id="relocation-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="relocation-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <form id="relocation-form">
        <div class="modal-header">
          <h2 id="relocation-dialog-title">別日への移動先を確認</h2>
        </div>
        <div class="modal-body">
          <p id="relocation-description" class="modal-helper">CSVで「別日」と入力された参加者、または「別日」ボタンから設定した参加者の移動先を選択してください。</p>
          <ul id="relocation-list" class="relocation-list" aria-live="polite"></ul>
          <p id="relocation-error" class="form-error" role="alert" hidden></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-dialog-dismiss="true">キャンセル</button>
          <button type="submit" class="btn btn-primary">設定を適用</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirm-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h2 id="confirm-dialog-title">確認</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-dialog-message"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" id="confirm-cancel-button" data-dialog-dismiss="true">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-accept-button">実行</button>
      </div>
    </div>
  </div>

  <telop-footer year="2025"></telop-footer>

  <script type="module" src="../scripts/question-admin/index.js"></script>
</body>
</html>
