<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Telop Display</title>
  <style>
    /* ====== Modern look (visual-only) ====== */
    :root{
      --text: #fff;
      --muted: #cfe3ff;
      --glass-bg: rgba(10,14,22,.55);
      --glass-border: rgba(255,255,255,.1);
      --glass-blur: 12px;
      --radius: 16px;
      --shadow: 0 20px 40px rgba(0,0,0,.35);
      --accent1: #7c3aed; /* 紫 */
      --accent2: #22d3ee; /* シアン */
    }
    /* 画面下部・全幅・16:9 の #telop-canvas を固定 */
    html, body {
      height: 100%;
      margin: 0;
    }
    #telop-canvas {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      width: 100vw;
      aspect-ratio: 1920 / 1080;   /* 幅から高さを16:9で算出 */
      display: flex;
      flex-direction: column;
      align-items: center;          /* 水平中央（テロップ塊を中央に） */
      justify-content: flex-end;    /* 垂直は下寄せ */
      box-sizing: border-box;
      padding: 1vh 2.5vw 1vh;         /* 下の余白 */
      color: #fff;
      font-family: "Noto Sans JP","Hiragino Sans","Meiryo",system-ui,sans-serif;
    }
    
    /* テロップの箱（左揃えのブロックを中央配置） */
    #telop-canvas .telop-box{
      position: relative;
      display: inline-block;
      text-align: left;             /* 行は左揃え */
      width:95%;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--glass-blur)) saturate(140%);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(140%);
      overflow: hidden;
      padding: 1.5vh 2.5vw;
    }
    /* グラデのアウトライン（うっすら） */
    #telop-canvas .telop-box::before{
      content:"";
      position:absolute; inset:0; border-radius: inherit; padding:1px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      pointer-events:none; opacity:.25;
    }
    /* 斜めの光沢 */
    #telop-canvas .telop-box::after{
      content:""; position:absolute; inset:-60%;
      background: conic-gradient(from 200deg at 50% 50%, rgba(255,255,255,.08), transparent 40%);
      transform: rotate(8deg);
      pointer-events:none; mix-blend-mode: overlay; opacity:.5;
    }

    /* 見出し（任意） */
    #radio-name {
      width: fit-content;
      font-weight: 700;
      font-size: calc(90vw / 25.7);
      line-height: 1.2;
      color: var(--muted);
      text-shadow: 0 1px 0 rgba(0,0,0,.4);
      margin: 2px 0 6px;
      letter-spacing: .01em;
    }
    #radio-name::before{
      content: "ラジオネーム:";
      font-size: calc(90vw / 32); /* 小さめ */
      margin-right: .5em;
      color: var(--muted);
      font-weight: 700;
    }
    #radio-name.no-label::before{ content:none; }

    /* ─ ここが“1行23文字”の肝 ─
       23ic（CJK全角23文字幅）に固定。非対応ブラウザは 23em にフォールバック。 */
    #question {
      width: fit-content;
      font-weight: 700;
      font-size: calc(90vw / 22.17);              /* 56–72pxあたりで微調整OK */
      line-height: 1.25;
      letter-spacing: .01em;
      white-space: normal;
      line-break: strict;           /* 日本語の禁則寄り */
      overflow-wrap: anywhere;      /* 英数や句読点が続いても崩れにくく */
      color: var(--text);
      text-shadow: 0 2px 12px rgba(0,0,0,.45);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin-top: auto;
    }
    
    /* 入れ替え時に“ふわっ”と表示（任意） */
    .animate-in{ animation: fadeSlideUp .28s ease-out both; }
    @keyframes fadeSlideUp{
      from{ opacity:0; transform: translateY(8px) scale(.995); }
      to  { opacity:1; transform: translateY(0)   scale(1); }
    }
    /* ルビ（任意） */
    ruby { ruby-position: under; }
    rt   { font-size: .5em; line-height: 1; }
  </style>
</head>
<body>

  <!-- ★ あなたの条件：#telop-canvas を下部・全幅・16:9で固定 -->
  <div id="telop-canvas">
    <div class="telop-box">
      <div id="radio-name"></div>
      <div id="question"></div>
    </div>
  </div>

  <!-- Firebase スクリプトは既存のまま（IDも同じ） -->
  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
         };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const telopRef = ref(database, 'currentTelop');
        
        const radioNameEl = document.getElementById('radio-name');
        const questionEl = document.getElementById('question');

        let dictionary = [];
        const dictRef = ref(database, 'dictionary');
        onValue(dictRef, snap => { dictionary = snap.val() || []; });
        
        // テキストにルビを適用する関数
        function applyRuby(text) {
            if (!text) return '';
            let processedText = escapeHtml(text); // ベースをサニタイズ
            dictionary.forEach(item => {
                // 正規表現で単語を検索し、<ruby>タグに置換する
                // 'g'フラグですべてのマッチを置換
                const regex = new RegExp(escapeRegExp(item.term), 'g');
                processedText = processedText.replace(
                  regex,
                  `<ruby>${escapeHtml(item.term)}<rt>${escapeHtml(item.ruby)}</rt></ruby>`
                );
            });
            return processedText;
        }
        
        function escapeHtml(s){
          return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }        

        // 正規表現用の特殊文字をエスケープするヘルパー関数
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Firebaseの 'currentTelop' の場所の変更を監視する
        onValue(telopRef, (snapshot) => {
            const telopData = snapshot.val(); // 変更後のデータを取得

            if (telopData) {
                // データが存在する場合、テロップを表示
                const name = telopData?.name || '';
                radioNameEl.textContent = name;
                questionEl.innerHTML = applyRuby(telopData.question);
                const isPickup = (n) => String(n).trim().toLowerCase().replace(/\s+/g,'') === 'pickupquestion';
                radioNameEl.classList.toggle('no-label', isPickup(name));
                [radioNameEl, questionEl].forEach(el=>{
                  el.classList.remove('animate-in'); void el.offsetWidth; el.classList.add('animate-in');
                });
            } else {
                // データがnull（削除された）場合、テロップを消去
                radioNameEl.textContent = '';
                questionEl.innerHTML = '';
            }
        });
    </script>
</body>
</html>
