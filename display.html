<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Telop Display</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* スクロールバーを非表示に */
        }
        #telop-canvas {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            aspect-ratio: 1920 / 1080; /* 常に16:9を維持 */
            background-color: rgba(0, 0, 0, 0.5); /* 確認しやすいように背景色を仮設定 */
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-sizing: border-box;
            padding: 2%;
        }
        #radio-name {
            font-size: 5vmin; /* ビューポートに対する相対的なサイズ */
            font-weight: bold;
        }
        #question {
            font-size: 7vmin;
            margin-top: 1%;
        }
    </style>
</head>
<body>
    <div id="telop-canvas">
        <div id="radio-name"></div>
        <div id="question"></div>
    </div>

    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxYtklsVbr2OmtaMISPMw0x2u0shjiUdwkym2oTZW7Xk14pcWxXG1lTcVC2GZAzjobapQ/exec';
        const radioNameEl = document.getElementById('radio-name');
        const questionEl = document.getElementById('question');
        
        let dictionary = []; // ルビ辞書を保存する配列
        
        // ルビ辞書をGASから非同期で取得する
        async function loadDictionary() {
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=dictionary`);
                const result = await response.json();
                if (result.success) {
                    // 有効な(enabled=true)辞書だけを保持
                    dictionary = result.data.filter(item => item.enabled === true);
                }
            } catch (error) {
                console.error('Failed to load dictionary:', error);
            }
        }
        
        // テキストにルビを適用する関数
        function applyRuby(text) {
            if (!text || dictionary.length === 0) {
                return text;
            }
            let processedText = text;
            dictionary.forEach(item => {
                // 正規表現で単語を検索し、<ruby>タグに置換する
                // 'g'フラグですべてのマッチを置換
                const regex = new RegExp(escapeRegExp(item.term), 'g');
                processedText = processedText.replace(regex, `<ruby>${item.term}<rt>${item.ruby}</rt></ruby>`);
            });
            return processedText;
        }
        
        // 正規表現用の特殊文字をエスケープするヘルパー関数
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        
        // --- 既存のコードを少し変更 ---
        window.addEventListener('storage', (event) => {
            if (event.key === 'currentTelop') {
                updateTelop();
            }
        });
        
        // ページ読み込み時に辞書を読み込み、テロップを更新
        loadDictionary().then(() => {
            updateTelop();
        });
        
        function updateTelop() {
            const telopDataJSON = localStorage.getItem('currentTelop');
            if (telopDataJSON) {
                const telopData = JSON.parse(telopDataJSON);
                radioNameEl.textContent = `RN: ${telopData.name}`;
        
                // ルビを適用してから表示する
                // innerHTMLを使ってHTMLタグを解釈させる
                questionEl.innerHTML = applyRuby(telopData.question); 
            } else {
                radioNameEl.textContent = '';
                questionEl.innerHTML = ''; // innerHTMLに変更
            }
        }
    </script>
</body>
</html>
