<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Telop Display</title>
  <style>
    /* === GenEi Gothic P / H-KL を登録（アップ済みの woff2 を使用） === */
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-ExtraLight.woff2") format("woff2");
      font-weight: 200; font-style: normal; font-display: swap;
    }
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-Light.woff2") format("woff2");
      font-weight: 300; font-style: normal; font-display: swap;
    }
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-Regular.woff2") format("woff2");
      font-weight: 400; font-style: normal; font-display: swap;
    }
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-SemiBold.woff2") format("woff2");
      font-weight: 600; font-style: normal; font-display: swap;
    }
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-Bold.woff2") format("woff2");
      font-weight: 700; font-style: normal; font-display: swap;
    }
    @font-face{
      font-family: "GenEiGothicP";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-Heavy.woff2") format("woff2");
      font-weight: 900; font-style: normal; font-display: swap;
    }
    /* H-KL（質問本文用）
       → 日本語だけを担当させ、英数字は通常の P にフォールバックさせる */
    @font-face{
      font-family: "GenEiGothicP-HKL";
      src: url("/assets/fonts/genei-gothic/GenEiGothicP-H-KL.woff2") format("woff2");
      font-weight: 400; font-style: normal; font-display: swap;
      unicode-range:
        U+3000-303F,      /* CJK記号・句読点 */
        U+3040-309F,      /* ひらがな */
        U+30A0-30FF,      /* カタカナ */
        U+4E00-9FFF,      /* CJK統合漢字 */
        U+FF01-FF60, U+FFE0-FFE6; /* 全角英数・記号 */
    }

    /* ====== Modern look (visual-only) ====== */
    :root{
      --neon-a: #00eaff;    /* シアン系 */
      --neon-b: #ff2a6d;    /* マゼンタ系 */
      --seat-bg1: rgba(4,7,12,.76);   /* 座布団の濃いめグラデ上 */
      --seat-bg2: rgba(3,5,9,.82);    /* 座布団の濃いめグラデ下 */
      --seat-border: rgba(255,255,255,.10);
      --radius: 18px;
      --shadow: 0 22px 48px rgba(0,0,0,.38);
    }
    /* 画面下部・全幅・16:9 の #telop-canvas を固定 */
    html, body {
      height: 100%;
      margin: 0;
    }
    #telop-canvas {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      width: 100vw;
      aspect-ratio: 1920 / 1080;   /* 幅から高さを16:9で算出 */
      display: flex;
      flex-direction: column;
      align-items: center;          /* 水平中央（テロップ塊を中央に） */
      justify-content: flex-end;    /* 垂直は下寄せ */
      box-sizing: border-box;
      padding: 1vh 2.5vw 1vh;         /* 下の余白 */
      color: #fff;
      font-family: "Noto Sans JP","Hiragino Sans","Meiryo",system-ui,sans-serif;
    }
    
    /* テロップの箱（左揃えのブロックを中央配置） */
    #telop-canvas .telop-box{
      position: relative;
      display: inline-block;
      text-align: left;             /* 行は左揃え */
      width:95%;
      background: linear-gradient(180deg, var(--seat-bg1), var(--seat-bg2));
      border: 1px solid var(--seat-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(150%);
      -webkit-backdrop-filter: blur(14px) saturate(150%);
      overflow: hidden;
      padding: 1.5vh 2.5vw;
      /* ▼ 追加：サイズ変化の見せ方を“下基準”に（FLIP用） */
      transform-origin: bottom center;
      will-change: transform;
    }
    /* ネオンの発光する枠線（細い管 + ぼんやりグロー） */
    #telop-canvas .telop-box::before,
    #telop-canvas .telop-box::after{
      content:""; position:absolute; inset:0; border-radius: inherit; pointer-events:none;
    }
    
    /* 細いネオンチューブ（輪郭） */
    #telop-canvas .telop-box::before{
      padding: 1px;                                 /* 細いチューブ */
      background: linear-gradient(135deg, var(--neon-a), var(--neon-b));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity: .9;
    }
    
    /* ぼんやり広がるグロー（外側のにじみ） */
    #telop-canvas .telop-box::after{
      background: linear-gradient(135deg, var(--neon-a), var(--neon-b));
      filter: blur(18px);
      opacity: .45;
      transform: scale(1.03);
    }
    
    /* うっすら底辺の“ネオンバー”を追加（2px） */
    #telop-canvas .telop-box > .neon-underline {
      content:"";
      display: block;
      width: 90vw;
      height: 2px;
      margin: 3px auto;
      background: linear-gradient(90deg, var(--neon-a), var(--neon-b));
      filter: drop-shadow(0 0 8px rgba(0,234,255,.45)) drop-shadow(0 0 8px rgba(255,42,109,.35));
      border-radius: 2px;
      pointer-events: none;
    }

    /* 質問未選択時：ラベルを出さない（保険） */
    #radio-name:empty::before { content: none; }

    /* ─ 表示状態（displayは使わずにアニメ可能にする） ─ */
    #telop-canvas.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    #telop-canvas.show   { opacity: 1; visibility: visible;  }
    #telop-canvas.hide   { opacity: 1; visibility: visible;  } /* 退場アニメ中 */

    /* 入退場アニメ（座布団ごと） */
    #telop-canvas.show .telop-box{
      animation: telopIn .36s cubic-bezier(.2,.7,.2,1) both;
      will-change: transform, opacity, filter;
    }
    #telop-canvas.hide .telop-box{
      animation: telopOut .28s cubic-bezier(.2,.7,.2,1) both;
      will-change: transform, opacity, filter;
    }
    @keyframes telopIn{
      0%   { opacity:0; transform: translateY(16px) scale(.985); filter: blur(6px); }
      60%  { opacity:1; transform: translateY(-2px) scale(1.005); filter: blur(0); }
      100% { opacity:1; transform: translateY(0)    scale(1); }
    }
    @keyframes telopOut{
      0%   { opacity:1; transform: translateY(0)    scale(1);    filter: blur(0); }
      100% { opacity:0; transform: translateY(12px) scale(.985); filter: blur(6px); }
    }
    @media (prefers-reduced-motion: reduce){
      #telop-canvas.show .telop-box,
      #telop-canvas.hide .telop-box{ animation: none; }
    }

    /* ───────── 内容入替アニメ（テキスト行用） ───────── */
    .text-swap-out{ animation: textOut .18s ease both; }
    .text-swap-in { animation: textIn  .22s ease both; }
    @keyframes textOut{
      0%   { opacity:1; transform: translateY(0);   filter: blur(0); }
      100% { opacity:0; transform: translateY(-6px); filter: blur(4px); }
    }
    @keyframes textIn{
      0%   { opacity:0; transform: translateY(6px); filter: blur(4px); }
      100% { opacity:1; transform: translateY(0);   filter: blur(0); }
    }
    @media (prefers-reduced-motion: reduce){
      .text-swap-out, .text-swap-in{ animation:none !important; }
    }
    
    /* 見出し（任意） */
    #radio-name {
      color: #ffffff;
      width: fit-content;
      /* ラジオネーム本文＝Bold */
      font-family: "GenEiGothicP","Noto Sans JP",system-ui,sans-serif;
      font-weight: 700;
      font-size: calc(90vw / 25.7);
      line-height: 1.2;
      text-shadow:
        1px 0 0 rgba(0,0,0,.55), -1px 0 0 rgba(0,0,0,.55),
        0 1px 0 rgba(0,0,0,.55),  0 -1px 0 rgba(0,0,0,.55),
        1px 1px 0 rgba(0,0,0,.45), 1px -1px 0 rgba(0,0,0,.45),
        -1px 1px 0 rgba(0,0,0,.45), -1px -1px 0 rgba(0,0,0,.45),
        0 0 8px rgba(0,234,255,.18);
      margin: 2px 0 6px;
      letter-spacing: .01em;
    }
    #radio-name::before{
      content: "ラジオネーム:";
      font-size: calc(90vw / 32); /* 小さめ */
      margin-right: .5em;
      color: #ffffff;
      opacity: .95;
      font-family: "GenEiGothicP","Noto Sans JP",system-ui,sans-serif;
      font-weight: 400;
    }
    #radio-name.no-label::before{ content:none; }

    /* ─ ここが“1行23文字”の肝 ─
       23ic（CJK全角23文字幅）に固定。非対応ブラウザは 23em にフォールバック。 */
    #question {
      width: fit-content;
      font-family: "GenEiGothicP-HKL","GenEiGothicP","Noto Sans JP",system-ui,sans-serif;
      font-weight: 800;
      font-size: calc(90vw / 22.17);              /* 56–72pxあたりで微調整OK */
      line-height: 1.25;
      letter-spacing: .01em;
      white-space: normal;
      line-break: strict;           /* 日本語の禁則寄り */
      overflow-wrap: anywhere;      /* 英数や句読点が続いても崩れにくく */
      color: #fff;
      text-shadow:
        1.2px 0 0 rgba(0,0,0,.70),  -1.2px 0 0 rgba(0,0,0,.70),
        0 1.2px 0 rgba(0,0,0,.70),   0 -1.2px 0 rgba(0,0,0,.70),
        1.2px 1.2px 0 rgba(0,0,0,.60), 1.2px -1.2px 0 rgba(0,0,0,.60),
        -1.2px 1.2px 0 rgba(0,0,0,.60), -1.2px -1.2px 0 rgba(0,0,0,.60),
        0 0 10px rgba(0,234,255,.22),
        0 0 20px rgba(255,42,109,.16);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin-top: auto;
    }

    /* プロポーショナル関連の機能を“明示的にON”にする */
    #radio-name,
    #question{
      /* 文字詰め（カーニング）を使う */
      font-kerning: normal;
      /* 東アジア文字をプロポーショナル幅に（'pwid' 相当） */
      /* かなも個別にプロポーショナルにしたいなら追加（'pkna' 相当） */
      font-variant-east-asian: proportional-width proportional-kana;
      /* OpenType 機能を明示（対応フォント・ブラウザで有効） */
      font-feature-settings: "palt" 1, "kern" 1; /* 横組み代替('palt')＋カーニング */
    }

    
    /* 入れ替え時に“ふわっ”と表示（任意） */
    .animate-in{ animation: fadeSlideUp .28s ease-out both; }
    @keyframes fadeSlideUp{
      from{ opacity:0; transform: translateY(8px) scale(.995); }
      to  { opacity:1; transform: translateY(0)   scale(1); }
    }
    @media (prefers-reduced-motion: no-preference){
      #telop-canvas .telop-box::after{
        animation: neonPulse 5s ease-in-out infinite;
      }
      @keyframes neonPulse{
        0%, 100% { opacity:.40; }
        15%      { opacity:.48; }
        20%      { opacity:.36; }
        55%      { opacity:.44; }
      }
    }
    /* ルビ（任意） */
    ruby { ruby-position: under; }
    rt   {
      font-size: .5em; line-height: 1;
      color:#ffffff;
      -webkit-text-stroke: 0.4px rgba(0,0,0,.55);
      text-shadow:
        0.8px 0 0 rgba(0,0,0,.45), -0.8px 0 0 rgba(0,0,0,.45),
        0 0.8px 0 rgba(0,0,0,.45),  0 -0.8px 0 rgba(0,0,0,.45);
    }
  </style>
</head>
<body>

  <!-- ★ あなたの条件：#telop-canvas を下部・全幅・16:9で固定 -->
  <div id="telop-canvas">
    <div class="telop-box">
      <div id="radio-name"></div>
      <i class="neon-underline"></i> <!-- ← これだけ追加（空要素） -->
      <div id="question"></div>
    </div>
  </div>

  <!-- Firebase スクリプトは既存のまま（IDも同じ） -->
  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
         };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const telopRef = ref(database, 'currentTelop');
        
        const radioNameEl = document.getElementById('radio-name');
        const questionEl = document.getElementById('question');
        const telopCanvas = document.getElementById('telop-canvas');

        // 初期状態は非表示に（データ到着まで）
        telopCanvas.classList.add('hidden');
    
        // 表示/非表示の制御ヘルパ
        function showTelop(){
          telopCanvas.classList.remove('hidden','hide');
          void telopCanvas.offsetWidth;            // アニメ再起動
          telopCanvas.classList.add('show');
        }
        function hideTelop(){
          if (telopCanvas.classList.contains('hidden')) return; // 既に消えている
          telopCanvas.classList.remove('show');
          telopCanvas.classList.add('hide');
        }
        // 退場アニメが終わったら完全に隠す
        const telopBox = document.querySelector('#telop-canvas .telop-box');
        telopBox?.addEventListener('animationend', (e)=>{
          if (e.animationName === 'telopOut'){
            telopCanvas.classList.add('hidden');
            telopCanvas.classList.remove('hide');
          }
        });

        // ─ 内容入替アニメ（Promise化：完了を待てるように）
        function swapText(el, setContent){
          return new Promise((resolve)=>{
            el.classList.remove('text-swap-in','text-swap-out');
            void el.offsetWidth; // restart
            el.classList.add('text-swap-out');
            el.addEventListener('animationend', () => {
              setContent();                          // 差し替え
              el.classList.remove('text-swap-out');
              void el.offsetWidth;
              el.classList.add('text-swap-in');
              el.addEventListener('animationend', () => {
                el.classList.remove('text-swap-in');
                resolve();
              }, { once:true });
            }, { once:true });
          });
        }
    
        // ─ 座布団のサイズ変化を“滑らかに見せる”FLIPアニメ
        function animateBoxResize(prevH){
          const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          const newH   = telopBox.offsetHeight || 0;
          if (reduce || !prevH || !newH) return;
          const diff   = Math.abs(newH - prevH);
          if (diff < 2) return; // 微小差は無視
          const scaleY = prevH / newH;
          telopBox.animate(
            [{ transform: `scaleY(${scaleY})` }, { transform: 'scaleY(1)' }],
            { duration: 240, easing: 'cubic-bezier(.2,.7,.2,1)' }
          );
        }
    
        let prevName = '', prevQuestion = '';
    
        let dictionary = [];
        const dictRef = ref(database, 'dictionary');
        onValue(dictRef, snap => { dictionary = snap.val() || []; });
        
        // テキストにルビを適用する関数
        function applyRuby(text) {
            if (!text) return '';
            let processedText = escapeHtml(text); // ベースをサニタイズ
            dictionary.forEach(item => {
                // 正規表現で単語を検索し、<ruby>タグに置換する
                // 'g'フラグですべてのマッチを置換
                const regex = new RegExp(escapeRegExp(item.term), 'g');
                processedText = processedText.replace(
                  regex,
                  `<ruby>${escapeHtml(item.term)}<rt>${escapeHtml(item.ruby)}</rt></ruby>`
                );
            });
            return processedText;
        }
        
        function escapeHtml(s){
          return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }        

        // 正規表現用の特殊文字をエスケープするヘルパー関数
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Firebaseの 'currentTelop' の場所の変更を監視する
        onValue(telopRef, (snapshot) => {
          const telopData  = snapshot.val() || null;
          const name       = telopData?.name ?? '';
          const question   = telopData?.question ?? '';
          const hasQuestion = !!(question && question.trim().length);
    
          if (!hasQuestion){
            // 非表示へ（座布団ごと退場）
            hideTelop();
            radioNameEl.textContent = '';
            questionEl.innerHTML    = '';
            radioNameEl.classList.remove('no-label');
            prevName = ''; prevQuestion = '';
            return;
          }
    
          // ラベル制御（Pick Up Question はラベル非表示）
          const isPickup = (n) => String(n).trim().toLowerCase().replace(/\s+/g,'') === 'pickupquestion';
          radioNameEl.classList.toggle('no-label', isPickup(name));
    
          const nameChanged = name.trim() !== prevName.trim();
          const qChanged    = question.trim() !== prevQuestion.trim();
    
          // 座布団自体は出す（入場アニメは showTelop が担当）
          if (telopCanvas.classList.contains('hidden')) {
            radioNameEl.textContent = name;
            questionEl.innerHTML    = applyRuby(question);
            showTelop();
          } else {
            // 表示中：変わったパートだけ“入替アニメ”＋座布団のサイズをFLIPで補間
            const prevH = telopBox.offsetHeight;
            const tasks = [];
            if (nameChanged) tasks.push(swapText(radioNameEl, () => { radioNameEl.textContent = name; }));
            if (qChanged)    tasks.push(swapText(questionEl, () => { questionEl.innerHTML = applyRuby(question); }));
            if (tasks.length){
              Promise.all(tasks).then(()=> animateBoxResize(prevH));
            }
          }
          prevName = name; prevQuestion = question;
        });
  </script>
</body>
</html>
