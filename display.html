<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Telop Display</title>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* スクロールバーを非表示に */
        }
        #telop-canvas {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            aspect-ratio: 1920 / 1080; /* 常に16:9を維持 */
            background-color: rgba(0, 0, 0, 0.5); /* 確認しやすいように背景色を仮設定 */
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-sizing: border-box;
            padding: 2%;
        }
        #radio-name {
            font-size: 5vmin; /* ビューポートに対する相対的なサイズ */
            font-weight: bold;
        }
        #question {
            font-size: 7vmin;
            margin-top: 1%;
        }
    </style>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
          authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
          databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "subtitle-output-system-9bc14",
          storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
          messagingSenderId: "378400426909",
          appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    </script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>
    <div id="telop-canvas">
        <div id="radio-name"></div>
        <div id="question"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
         };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const telopRef = ref(database, 'currentTelop');
        
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxYtklsVbr2OmtaMISPMw0x2u0shjiUdwkym2oTZW7Xk14pcWxXG1lTcVC2GZAzjobapQ/exec';
        const radioNameEl = document.getElementById('radio-name');
        const questionEl = document.getElementById('question');
        
        let dictionary = []; // ルビ辞書を保存する配列
        
        // ルビ辞書をGASから非同期で取得する
        async function loadDictionary() {
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=dictionary`);
                const result = await response.json();
                if (result.success) {
                    // 有効な(enabled=true)辞書だけを保持
                    dictionary = result.data.filter(item => item.enabled === true);
                }
            } catch (error) {
                console.error('Failed to load dictionary:', error);
            }
        }
        
        // テキストにルビを適用する関数
        function applyRuby(text) {
            if (!text || dictionary.length === 0) {
                return text;
            }
            let processedText = text;
            dictionary.forEach(item => {
                // 正規表現で単語を検索し、<ruby>タグに置換する
                // 'g'フラグですべてのマッチを置換
                const regex = new RegExp(escapeRegExp(item.term), 'g');
                processedText = processedText.replace(regex, `<ruby>${item.term}<rt>${item.ruby}</rt></ruby>`);
            });
            return processedText;
        }
        
        // 正規表現用の特殊文字をエスケープするヘルパー関数
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // 辞書を最初に読み込む
        loadDictionary();

        // Firebaseの 'currentTelop' の場所の変更を監視する
        onValue(telopRef, (snapshot) => {
            const telopData = snapshot.val(); // 変更後のデータを取得

            if (telopData) {
                // データが存在する場合、テロップを表示
                radioNameEl.textContent = `RN: ${telopData.name}`;
                questionEl.innerHTML = applyRuby(telopData.question);
            } else {
                // データがnull（削除された）場合、テロップを消去
                radioNameEl.textContent = '';
                questionEl.innerHTML = '';
            }
        });
    </script>
</body>
</html>
