<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Telop Display</title>
  <style>
    /* 画面中央に 1920x1080 の“舞台”を固定 */
    html, body {
      height: 100%;
      margin: 0;
      background: #0b0f17;           /* 余白部の背景（任意） */
      display: grid;
      place-items: center;
    }

    .stage {
      position: relative;
      width: 1920px;
      height: 1080px;
      background: #000;              /* 必要なら映像/背景をここに */
      overflow: hidden;
    }

    /* テロップ（下部固定） */
    .telop {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      padding: 28px 0 44px;          /* 上下余白はお好みで */
      pointer-events: none;          /* クリック透過（任意） */
    }
    .telop-inner {
      display: flex;
      justify-content: center;       /* ブロックを水平中央に */
    }
    .telop-box {
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 16px 28px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      max-width: calc(100% - 160px); /* 端の余白バッファ */
    }

    /* 見出し（任意） */
    #radio-name {
      font-family: "Noto Sans JP", "Hiragino Sans", "Meiryo", system-ui, sans-serif;
      font-weight: 700;
      font-size: 36px;
      line-height: 1.2;
      color: #cfe3ff;
      text-align: left;              /* 行は左揃え */
      margin: 2px 0 6px;
      letter-spacing: .01em;
    }

    /* ── ここが“23文字/行”のキモ ────────────────
       CJKの1文字幅 ＝ 1ic。23ic 幅の箱に文字を入れると自然に23文字で折り返す。
       未対応ブラウザでも 23em をフォールバックに指定。 */
    #question {
      width: 23em;                   /* フォールバック */
      width: 23ic;                   /* 23文字幅（対応ブラウザで有効） */
      font-family: "Noto Sans JP", "Hiragino Sans", "Meiryo", system-ui, sans-serif;
      font-weight: 700;
      font-size: 64px;               /* お好みで（幅が固定なので23文字で改行される） */
      line-height: 1.25;
      letter-spacing: .01em;
      color: #fff;
      text-align: left;              /* 行は左揃え */
      white-space: normal;
      line-break: strict;            /* 日本語の禁則寄りに */
      overflow-wrap: anywhere;       /* 英数/句読点が続いても崩れにくく */
    }

    /* ルビの読みやすさ（任意） */
    ruby { ruby-position: under; }
    rt { font-size: .5em; line-height: 1; }
  </style>
</head>
<body>
  <div class="stage">
    <!-- 映像やキャンバスがあるならここに置く -->

    <!-- テロップ -->
    <div class="telop">
      <div class="telop-inner">
        <div class="telop-box">
          <div id="radio-name"></div>
          <div id="question"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ここより下の <script type="module"> は既存のままでOK（IDsは同じ） -->
  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
         };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const telopRef = ref(database, 'currentTelop');
        
        const radioNameEl = document.getElementById('radio-name');
        const questionEl = document.getElementById('question');

        let dictionary = [];
        const dictRef = ref(database, 'dictionary');
        onValue(dictRef, snap => { dictionary = snap.val() || []; });
        
        // テキストにルビを適用する関数
        function applyRuby(text) {
            if (!text) return '';
            let processedText = escapeHtml(text); // ベースをサニタイズ
            dictionary.forEach(item => {
                // 正規表現で単語を検索し、<ruby>タグに置換する
                // 'g'フラグですべてのマッチを置換
                const regex = new RegExp(escapeRegExp(item.term), 'g');
                processedText = processedText.replace(
                  regex,
                  `<ruby>${escapeHtml(item.term)}<rt>${escapeHtml(item.ruby)}</rt></ruby>`
                );
            });
            return processedText;
        }
        
        function escapeHtml(s){
          return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                          .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }        

        // 正規表現用の特殊文字をエスケープするヘルパー関数
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Firebaseの 'currentTelop' の場所の変更を監視する
        onValue(telopRef, (snapshot) => {
            const telopData = snapshot.val(); // 変更後のデータを取得

            if (telopData) {
                // データが存在する場合、テロップを表示
                radioNameEl.textContent = `RN: ${telopData.name}`;
                questionEl.innerHTML = applyRuby(telopData.question);
            } else {
                // データがnull（削除された）場合、テロップを消去
                radioNameEl.textContent = '';
                questionEl.innerHTML = '';
            }
        });
    </script>
</body>
</html>
