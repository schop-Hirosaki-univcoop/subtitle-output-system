<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>質問フォーム管理</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%2064%2064%27%3E%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2712%27%20fill%3D%2705111f%27%2F%3E%3Ctext%20x%3D%2732%27%20y%3D%2742%27%20text-anchor%3D%27middle%27%20font-family%3D%27Arial%2C%20sans-serif%27%20font-size%3D%2736%27%20fill%3D%2700eaff%27%3EM%3C%2Ftext%3E%3C%2Fsvg%3E">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="question-form.css">
  <script type="module" src="./scripts/shared/layout.js"></script>
</head>
<body class="op-theme question-admin-page">
  <div id="loading-overlay" aria-live="polite" hidden>
    <div class="loading-backdrop"></div>
    <div class="loading-panel" role="status" aria-label="読み込み中">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text"><span id="loading-text">初期化中…</span></div>
      <div class="loading-sub">数秒かかる場合があります</div>
      <ol id="loader-steps" class="loader-steps" aria-label="初期化ステップ"></ol>
    </div>
  </div>
  <telop-header tagline="Question Form Admin" context-label="管理ページ情報">
    <div slot="meta" id="user-info" class="user-info" hidden aria-hidden="true"></div>
    <button slot="actions" id="header-logout" class="btn btn-ghost btn-sm" type="button" hidden>ログアウト</button>
  </telop-header>

  <div id="login-card" class="auth-card" role="dialog" aria-labelledby="login-title">
    <h2 id="login-title">質問フォーム管理</h2>
    <p class="auth-lead">イベント・日程・参加者リストを管理するには、Googleアカウントでサインインしてください。</p>
    <button id="login-button" class="btn btn-primary" type="button">Googleアカウントでログイン</button>
    <p id="login-error" class="form-error" role="alert" hidden></p>
  </div>

  <main id="admin-main" class="admin-main" hidden>
    <section class="module module--primary admin-module" aria-labelledby="event-title">
      <div class="module-header">
        <div class="module-heading">
          <h1 id="event-title">イベントの管理</h1>
          <p class="module-description">質問フォームで使用するイベントを追加・編集・削除できます。</p>
        </div>
        <div class="module-actions">
          <button id="add-event-button" class="btn btn-primary btn-sm" type="button" disabled>イベントを追加</button>
          <button id="refresh-button" class="btn btn-ghost btn-sm" type="button">再読み込み</button>
          <button id="logout-button" class="btn btn-ghost btn-sm" type="button" hidden>ログアウト</button>
        </div>
      </div>
      <div class="module-body">
        <p id="event-context" class="admin-context">イベントを選択すると、日程と参加者リストを編集できます。</p>
        <ul id="event-list" class="entity-list" aria-live="polite"></ul>
        <p id="event-empty" class="entity-empty" hidden>まだイベントが登録されていません。まずはイベントを追加してください。</p>
      </div>
    </section>

    <section class="module module--primary admin-module" aria-labelledby="schedule-title">
      <div class="module-header">
        <div class="module-heading">
          <h2 id="schedule-title">日程の管理</h2>
          <p class="module-description" id="schedule-description">イベントを選択すると、日程の一覧が表示され、編集や削除も行えます。</p>
        </div>
        <div class="module-actions">
          <button id="add-schedule-button" class="btn btn-primary btn-sm" type="button" disabled>日程を追加</button>
        </div>
      </div>
      <div class="module-body">
        <ul id="schedule-list" class="entity-list" aria-live="polite"></ul>
        <p id="schedule-empty" class="entity-empty" hidden>選択中のイベントにはまだ日程が登録されていません。</p>
      </div>
    </section>

    <section class="module module--primary admin-module" aria-labelledby="participant-title">
      <div class="module-header">
        <div class="module-heading">
          <h2 id="participant-title">参加者リストの管理</h2>
          <p class="module-description" id="participant-description">日程を選択し、参加者情報（参加者IDを空欄にすると自動採番されます）をアップロードしてください。保存後は各参加者ごとに専用リンクを発行でき、一覧の「編集」から詳細や班番号を更新できます。電話番号とメールアドレスは内部で管理され、編集時のみ確認できます。同じイベント内で名前と学部学科が一致する参加者は、日程が同じでも異なっても重複候補として件数付きで表示されます。</p>
        </div>
      </div>
      <div class="module-body">
        <p id="participant-context" class="admin-context">日程を選択すると、現在登録されている参加者が表示されます。</p>
        <div class="admin-controls">
          <button id="download-participant-template" class="btn btn-ghost btn-sm" type="button">参加者CSVテンプレート</button>
          <label class="btn btn-ghost file-input" for="csv-input">
            <span id="file-label">CSVファイルを選択</span>
            <input id="csv-input" type="file" accept=".csv,text/csv">
          </label>
          <button id="download-team-template" class="btn btn-ghost btn-sm" type="button" disabled>班番号テンプレート</button>
          <label class="btn btn-ghost file-input" for="team-csv-input">
            <span id="team-file-label">班番号CSVを選択</span>
            <input id="team-csv-input" type="file" accept=".csv,text/csv">
          </label>
          <button id="clear-participants-button" class="btn btn-danger btn-sm" type="button" disabled>参加者リストを全削除</button>
          <button id="discard-button" class="btn btn-ghost btn-sm" type="button" disabled>変更を取り消す</button>
          <button id="save-button" class="btn btn-primary" type="button" disabled>参加者リストを保存</button>
          <span id="upload-status" class="status-pill">日程を選択してください。</span>
        </div>
        <div id="change-preview" class="change-preview" hidden aria-live="polite">
          <div class="change-preview__header">
            <span class="change-preview__title">未保存の変更があります</span>
            <span id="change-preview-count" class="change-preview__count"></span>
          </div>
          <ul id="change-preview-list" class="change-preview__list" aria-label="未保存の変更一覧"></ul>
          <p id="change-preview-note" class="change-preview__note">「参加者リストを保存」で変更を確定し、「変更を取り消す」で破棄できます。</p>
        </div>
        <p class="admin-summary" id="admin-summary"></p>
        <div class="table-scroller">
          <table class="mapping-table" aria-describedby="participant-description">
            <thead>
              <tr>
                <th scope="col">参加者ID</th>
                <th scope="col">氏名 / ラジオネーム</th>
                <th scope="col">フリガナ</th>
                <th scope="col">性別</th>
                <th scope="col">学部学科</th>
                <th scope="col">班番号</th>
                <th scope="col">専用リンク</th>
              </tr>
            </thead>
            <tbody id="mapping-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="module module--secondary admin-module" aria-labelledby="format-title">
      <div class="module-header">
        <div class="module-heading">
          <h2 id="format-title">CSVの形式について</h2>
          <p class="module-description">1列目から順に「参加者ID」「名前」「フリガナ」「性別」「学部学科」「携帯電話」「メールアドレス」を配置してください（参加者IDは空欄でも構いません）。アップロード時には必ずヘッダー行が必要です。テンプレートボタンからダウンロードできます。ファイル名は「イベントID_日程ID_participants.csv」を使用してください。電話番号とメールアドレスは内部で保存され、編集ダイアログでのみ確認できます。</p>
        </div>
      </div>
      <div class="module-body">
        <ul>
          <li>ヘッダー行（例: <code>参加者ID,名前,フリガナ,性別,学部学科,携帯電話,メールアドレス</code>）が必須です。</li>
          <li>同じ参加者IDや同じ氏名・学部学科の行が複数あっても全て読み込み、一覧上で重複候補として確認できます。</li>
          <li>参加者IDが空欄の場合は氏名などの情報から既存レコードを照合し、自動で番号を割り当てます。</li>
          <li>同じイベント内で名前と学部学科が一致する参加者は、日程が同じでも異なっても重複候補（件数付き）として一覧に表示されます。</li>
          <li>各列は空欄でもアップロードできますが、氏名は必須です。</li>
          <li>保存後はフォームに即座に反映されます。</li>
          <li>班番号は別途、<code>参加者ID,班番号</code>形式のCSV（ヘッダー必須）をアップロードすると一括で紐付けられます（キャンセルの場合は班番号に「キャンセル」と入力してください）。テンプレートには現在の参加者IDがあらかじめ記載されます。ファイル名は「イベントID_日程ID_teams.csv」としてください。</li>
        </ul>
      </div>
    </section>
  </main>

  <div id="event-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="event-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <form id="event-form">
        <div class="modal-header">
          <h2 id="event-dialog-title">イベントを追加</h2>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label for="event-name-input">イベント名</label>
            <input id="event-name-input" name="event-name" class="input" type="text" autocomplete="off" required data-autofocus>
          </div>
          <p class="modal-helper">質問フォーム上で表示されるイベント名を入力してください。</p>
          <p id="event-error" class="form-error" role="alert" hidden></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-dialog-dismiss="true">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加</button>
        </div>
      </form>
    </div>
  </div>

  <div id="participant-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="participant-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <form id="participant-form">
        <div class="modal-header">
          <h2 id="participant-dialog-title">参加者情報を編集</h2>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label for="participant-id-input">参加者ID</label>
            <input id="participant-id-input" name="participant-id" class="input" type="text" readonly>
          </div>
          <div class="modal-field">
            <label for="participant-name-input">氏名 / ラジオネーム</label>
            <input id="participant-name-input" name="participant-name" class="input" type="text" autocomplete="off" required>
          </div>
          <div class="modal-field">
            <label for="participant-phonetic-input">フリガナ</label>
            <input id="participant-phonetic-input" name="participant-phonetic" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-gender-input">性別</label>
            <input id="participant-gender-input" name="participant-gender" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-department-input">学部学科</label>
            <input id="participant-department-input" name="participant-department" class="input" type="text" autocomplete="off">
          </div>
          <div class="modal-field">
            <label for="participant-team-input">班番号</label>
            <input id="participant-team-input" name="participant-team" class="input" type="text" autocomplete="off" placeholder="例: A-1 / キャンセルなど">
          </div>
          <div class="modal-field">
            <label for="participant-phone-input">携帯電話</label>
            <input id="participant-phone-input" name="participant-phone" class="input" type="tel" autocomplete="tel">
          </div>
          <div class="modal-field">
            <label for="participant-email-input">メールアドレス</label>
            <input id="participant-email-input" name="participant-email" class="input" type="email" autocomplete="email">
          </div>
          <p id="participant-error" class="form-error" role="alert" hidden></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-dialog-dismiss="true">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <div id="schedule-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="schedule-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <form id="schedule-form">
        <div class="modal-header">
          <h2 id="schedule-dialog-title">日程を追加</h2>
        </div>
        <div class="modal-body">
          <div class="modal-field">
            <label for="schedule-label-input">日程の表示名</label>
            <input id="schedule-label-input" name="schedule-label" class="input" type="text" autocomplete="off" required data-autofocus>
          </div>
          <div class="modal-field">
            <label for="schedule-date-input">日付</label>
            <input id="schedule-date-input" name="schedule-date" class="input" type="date" required>
            <p class="modal-helper">カレンダーの日付をクリックするか、直接入力して選択してください。</p>
          </div>
          <div class="modal-field modal-calendar-field">
            <div id="schedule-dialog-calendar" class="dialog-calendar" aria-label="カレンダーから日付を選択">
              <div class="dialog-calendar-header">
                <button id="schedule-dialog-calendar-prev" class="dialog-calendar-nav" type="button" aria-label="前の月へ">
                  <span aria-hidden="true">‹</span>
                </button>
                <div id="schedule-dialog-calendar-title" class="dialog-calendar-title" aria-live="polite">&nbsp;</div>
                <button id="schedule-dialog-calendar-next" class="dialog-calendar-nav" type="button" aria-label="次の月へ">
                  <span aria-hidden="true">›</span>
                </button>
              </div>
              <div class="dialog-calendar-weekdays" aria-hidden="true">
                <span>日</span>
                <span>月</span>
                <span>火</span>
                <span>水</span>
                <span>木</span>
                <span>金</span>
                <span>土</span>
              </div>
              <div id="schedule-dialog-calendar-grid" class="dialog-calendar-grid" role="grid" aria-label="日付一覧"></div>
            </div>
          </div>
          <div class="modal-field">
            <label for="schedule-start-time-input">開始時刻</label>
            <input id="schedule-start-time-input" name="schedule-start-time" class="input" type="time" required>
          </div>
          <div class="modal-field">
            <label for="schedule-end-time-input">終了時刻</label>
            <input id="schedule-end-time-input" name="schedule-end-time" class="input" type="time" required>
          </div>
          <p class="modal-helper">入力した開始・終了の時刻は参加者向けの案内にも使用されます。</p>
          <p id="schedule-error" class="form-error" role="alert" hidden></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" data-dialog-dismiss="true">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirm-dialog" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-dialog-title" hidden>
    <div class="modal-backdrop" data-dialog-dismiss="true"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <h2 id="confirm-dialog-title">確認</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-dialog-message"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost" id="confirm-cancel-button" data-dialog-dismiss="true">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-accept-button">実行する</button>
      </div>
    </div>
  </div>

  <telop-footer year="2025"></telop-footer>

  <script type="module" src="./scripts/question-admin/index.js"></script>
</body>
</html>
