{
  "rules": {
    ".read": false,
    ".write": false,

    "render_state": {
      ".read": true,
      ".write": "auth != null && auth.token.firebase.sign_in_provider === 'anonymous' && root.child('screens/approved').child(auth.uid).val() == true",
      ".validate": "newData.hasChildren(['phase'])",
      "phase": {
        ".validate": "newData.isString() && newData.val().matches(/^(visible|hidden|showing|hiding|error)$/)"
      },
      "updatedAt": { ".validate": "newData.isNumber() || !newData.exists()" },
      "nowShowing": {
        ".validate": "!newData.exists() || (newData.hasChildren(['name','question']) && newData.child('name').isString() && newData.child('question').isString() && (!newData.child('uid').exists() || newData.child('uid').isString()) && (!newData.child('participantId').exists() || newData.child('participantId').isString()))",
        "uid": { ".validate": "newData.isString()" },
        "participantId": { ".validate": "newData.isString()" }
      }
    },

    "currentTelop": {
      ".read": true,
      ".write": "auth != null && root.child('admins').child(auth.uid).val() == true"
    },

    "questions": {
      ".read": "auth != null",
      "$uid": {
        ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
        ".validate": "newData.hasChildren(['uid','name','question'])",
        "uid":       { ".validate": "newData.isString()" },
        "name":      { ".validate": "newData.isString()" },
        "question":  { ".validate": "newData.isString()" },
        "group":     { ".validate": "newData.isString() || !newData.exists()" },
        "genre":     { ".validate": "newData.isString() || !newData.exists()" },
        "schedule":  { ".validate": "newData.isString() || !newData.exists()" },
        "ts":        { ".validate": "newData.isNumber() || !newData.exists()" },
        "participantId": { ".validate": "newData.isString() || !newData.exists()" },
        "answered":  { ".validate": "newData.isBoolean() || !newData.exists()" },
        "selecting": { ".validate": "newData.isBoolean() || !newData.exists()" },
        "updatedAt": { ".validate": "newData.isNumber()  || !newData.exists()" },
        "$other":    { ".validate": false }
      }
    },

    "dictionary": {
      ".read": true,
      ".write": "auth != null && root.child('admins').child(auth.uid).val() == true"
    },

    "questionIntake": {
      ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
      ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
      "events": {
        ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
        "$eventId": {
          ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
          ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
          ".validate": "!newData.exists() || (newData.hasChildren(['name']) && newData.child('name').isString())",
          "name": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
          "updatedAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
          "$other": { ".validate": false }
        }
      },
      "schedules": {
        ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
        "$eventId": {
          ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
          "$scheduleId": {
            ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
            ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
            ".validate": "!newData.exists() || (newData.hasChildren(['label']) && newData.child('label').isString())",
            "label": { ".validate": "newData.isString()" },
            "date": { ".validate": "newData.isString() || !newData.exists()" },
            "startAt": { ".validate": "newData.isString() || !newData.exists()" },
            "endAt": { ".validate": "newData.isString() || !newData.exists()" },
            "participantCount": { ".validate": "newData.isNumber() || !newData.exists()" },
            "createdAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
            "updatedAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
            "$other": { ".validate": false }
          }
        }
      },
      "participants": {
        ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
        "$eventId": {
          ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
          "$scheduleId": {
            ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
            "$participantId": {
              ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
              ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
              ".validate": "!newData.exists() || (newData.hasChildren(['participantId','name','groupNumber','token']) && newData.child('participantId').isString() && newData.child('name').isString() && newData.child('groupNumber').isString() && newData.child('token').isString())",
              "participantId": { ".validate": "newData.isString()" },
              "name": { ".validate": "newData.isString()" },
              "groupNumber": { ".validate": "newData.isString()" },
              "teamNumber": { ".validate": "newData.isString() || !newData.exists()" },
              "token": { ".validate": "newData.isString()" },
              "guidance": { ".validate": "newData.isString() || !newData.exists()" },
              "phonetic": { ".validate": "newData.isString() || !newData.exists()" },
              "furigana": { ".validate": "newData.isString() || !newData.exists()" },
              "gender": { ".validate": "newData.isString() || !newData.exists()" },
              "department": { ".validate": "newData.isString() || !newData.exists()" },
              "phone": { ".validate": "newData.isString() || !newData.exists()" },
              "email": { ".validate": "newData.isString() || !newData.exists()" },
              "updatedAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
              "$other": { ".validate": false }
            }
          }
        }
      },
      "tokens": {
        "$token": {
          ".read": true,
          ".write": "auth != null && root.child('admins').child(auth.uid).val() == true",
          ".validate": "!newData.exists() || (newData.hasChildren(['eventId','scheduleId','participantId','displayName','groupNumber']) && newData.child('eventId').isString() && newData.child('scheduleId').isString() && newData.child('participantId').isString() && newData.child('displayName').isString() && newData.child('groupNumber').isString())",
          "eventId": { ".validate": "newData.isString()" },
          "eventName": { ".validate": "newData.isString() || !newData.exists()" },
          "scheduleId": { ".validate": "newData.isString()" },
          "scheduleLabel": { ".validate": "newData.isString() || !newData.exists()" },
          "scheduleDate": { ".validate": "newData.isString() || !newData.exists()" },
          "scheduleStart": { ".validate": "newData.isString() || !newData.exists()" },
          "scheduleEnd": { ".validate": "newData.isString() || !newData.exists()" },
          "participantId": { ".validate": "newData.isString()" },
          "displayName": { ".validate": "newData.isString()" },
          "groupNumber": { ".validate": "newData.isString()" },
          "teamNumber": { ".validate": "newData.isString() || !newData.exists()" },
          "guidance": { ".validate": "newData.isString() || !newData.exists()" },
          "expiresAt": { ".validate": "newData.isNumber() || !newData.exists()" },
          "updatedAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
          "createdAt": { ".validate": "newData.isNumber() || newData.val() == now || !newData.exists()" },
          "revoked": { ".validate": "newData.isBoolean() || !newData.exists()" },
          "$other": { ".validate": false }
        }
      }
    },

    "update_trigger": {
      ".read": true,
      ".write": "auth != null"
    },

    "admins": {
      ".read": false,
      ".write": "auth != null && root.child('admins').child(auth.uid).val() == true"
    },

    "render_control": {
      ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
      ".write": false
    },

    "screens": {
      "approved": {
        "$uid": {
          ".read": "auth != null && auth.token.firebase.sign_in_provider === 'anonymous' && auth.uid === $uid",
          ".write": false
        }
      },
      "sessions": {
        "$uid": {
          ".read": "auth != null && root.child('admins').child(auth.uid).val() == true",
          ".write": false
        }
      }
    }
  }
}
