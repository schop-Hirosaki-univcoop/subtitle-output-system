<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WPなんでも相談ラジオ｜送出コントロール</title>
  <link rel="stylesheet" href="common.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="layout">
    <!-- ▼ ヘッダー（3行構成） -->
    <header id="header">
      <div id="title-row" class="panel-header">
        <div id="page-title">テロップ送出コントロール（PVW/PGM）</div>
      </div>
      <div id="stats-row">
        <div id="stats-left" class="counters">
          総件数: <span id="count-total">0</span> /
          PGM: <span id="count-onair">0</span> /
          回答済: <span id="count-completed">0</span>
        </div>
        <div id="stats-right">
          <span id="disp-badge" class="badge" title="Display heartbeat">
            <span class="dot"></span><span class="label">DISPLAY</span><span id="disp-text">--</span>
          </span>
        </div>
      </div>
      <div id="tool-row" class="tools">
        <label class="only-open"><input type="checkbox" id="filter-open" class="ui-switch" /> 未送出のみ</label>
        <input id="search" type="search" placeholder="ラジオネーム/班/質問で検索（/ でフォーカス）" />
        <div id="safe-controls">
          <label class="only-open"><input type="checkbox" id="toggle-safe" class="ui-switch" /> セーフマージン</label>
          <select id="safe-preset" title="プリセット" class="ui-select">
            <option value="modern" selected>HD: Title 5% / Action 3.5%</option>
            <option value="legacy">SD: Title 10% / Action 5%</option>
          </select>
        </div>
      </div>
    </header>

    <!-- ▼ 2行目：左＝送出ログ ／ 右＝画面グループ -->
    <div id="row2">
      <section id="log-rail" class="panel" aria-label="送出ログと辞書">
        <div class="panel-header">送出ログ</div>
        <div id="tab-log" class="tabpanel active">
          <div id="oplog-wrap">
            <div class="oplog-title">直近の操作</div>
            <ul id="oplog"></ul>
          </div>
        </div>
      </section>
      <section id="control-rail" class="panel" aria-label="送出コントロール">
        <div id="preview-row">
          <div id="preview-contents">
            <div id="tab-monitors" class="tabpanel active" role="tabpanel">
              <div class="monitors-grid">
                <aside id="pvw-preview" title="PVW（キュー中のプレビュー）">
                  <div id="pvw-mirror"></div>
                  <div class="pvw-tag">PVW</div>
                </aside>
                <aside id="display-preview" title="PGM（本線プレビュー）">
                  <div id="preview-mirror"></div>
                  <div class="pgm-tag">PGM</div>
                </aside>
                <div id="actions">
                  <button id="approve-button" class="standby" title="ダブルクリックでTAKE">TAKE</button>
                  <button id="reject-button" title="送出済を解除して再エントリー">再エントリー</button>
                  <button id="reset-all-button" title="送出済を全解除して再エントリー">全再エントリー</button>
                  <button id="jump-onair-button" title="PGM 中の項目へスクロール＆選択">PGMへジャンプ</button>
                  <button id="force-standby-button" title="現在のPGMを即時CLEAR">PANIC CLEAR</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- ▼ 3行目：質問リスト -->
    <main id="right-pane"><ul id="nameList"></ul></main>
  </div>

  <!-- ▼ 右サイド独立ドロワー：ルビ辞書（GAS時代仕様に完全再現） -->
  <div id="dict-drawer">
    <div class="drawer-rail">
      <button id="toggle-dict" class="dict-tab" type="button" title="ルビ辞書を開閉" aria-controls="dict-drawer" aria-expanded="false">辞書</button>
      <div class="drawer-panel" role="complementary" aria-label="ルビ辞書パネル">
        <div class="drawer-header">
          <div class="panel-header">ルビ辞書</div>
          <button id="dict-drawer-close" class="ghost-btn" type="button" aria-label="閉じる">閉じる</button>
        </div>
        <div id="dict-drawer-body">
          <!-- #dict-paneがここにJSで移設される -->
        </div>
      </div>
    </div>
  </div>
  <!-- #dict-pane本体 -->
  <aside id="dict-pane" title="ルビ辞書">
    <div class="panel-header">
      <span>ルビ辞書</span>
      <button id="dict-reload" type="button" class="ghost-btn" title="辞書を再読み込み">再読み込み</button>
      <button id="dict-bulk-edit" type="button" class="ghost-btn" title="有効/削除の一括管理モード">一括管理</button>
    </div>
    <form id="dict-form" onsubmit="return false;">
      <div class="row-fields">
        <input id="dict-term" placeholder="用語（例：挨拶）" required />
        <input id="dict-ruby" placeholder="よみ（例：あいさつ）" required />
      </div>
      <div class="row-apply">
        <select id="dict-mode" title="一致方法" class="ui-select">
          <option value="any">any（どこでも）</option>
          <option value="both">both（前後が非語境界）</option>
          <option value="left">left（行頭/直前のみ）</option>
          <option value="right">right（行末/直後のみ）</option>
          <option value="regex">regex（正規表現）</option>
        </select>
        <button id="dict-save">追加 / 上書き</button>
      </div>
      <div class="row-csv">
        <div class="row-label">CSV：</div>
        <button id="btn-export-dict" type="button" title="CSVをダウンロード">出力</button>
        <button id="btn-import-dict" type="button" title="CSVを読み込む">取込</button>
        <select id="import-strategy" title="方式" class="ui-select">
          <option value="merge" selected>統合（上書き）</option>
          <option value="replace">置換（全入替）</option>
        </select>
      </div>
      <input id="file-import-dict" type="file" accept=".csv" hidden />
    </form>
    <div class="dict-table-wrap">
      <table id="dict-table">
        <thead>
          <tr>
            <th class="col-select"  title="全選択/解除">
              <input type="checkbox" id="dict-select-all" aria-label="全選択/解除" />
            </th>
            <th class="col-term">用語</th>
            <th class="col-ruby">よみ</th>
            <th class="col-mode">mode</th>
          </tr>
        </thead>
        <tbody id="dict-tbody"></tbody>
      </table>
    </div>
    <div id="dict-action-panel" role="group" aria-label="辞書操作パネル">
      <div class="normal-actions">
        <div class="sel-info">選択: <span id="dict-sel-summary">なし</span></div>
        <label class="ui-switch-wrap">有効
          <input type="checkbox" id="dict-toggle-enabled" class="ui-switch" />
        </label>
        <button id="dict-edit-row" class="edit-btn">編集</button>
        <button id="dict-delete-row" class="dict-del">削除</button>
      </div>
      <div id="dict-bulk-toolbar" class="bulk-actions" hidden>
        <div class="sel-info">選択: <span id="dict-bulk-count">0</span>件</div>
        <button id="dict-bulk-enable" class="edit-btn">選択を有効化</button>
        <button id="dict-bulk-disable" class="edit-btn">選択を無効化</button>
        <button id="dict-bulk-delete" class="dict-del">選択を削除</button>
        <button id="dict-bulk-save">一括保存</button>
        <button id="dict-bulk-cancel">キャンセル</button>
      </div>
    </div>
  </aside>

  <!-- ▼ 復活：オーバーレイ -->
  <div id="overlay" aria-live="polite" aria-busy="true">
    <div class="panel">
      <div class="spinner"></div>
      <div class="msg" id="overlay-msg">送出更新中…</div>
      <div class="sub">本線プレビューの反映まで数秒かかる場合があります</div>
    </div>
  </div>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ========== templates ========== -->
  <template id="tpl-selected">
    <li class="name-box" data-uid="">
      <div class="top-row">
        <div class="rname-chip"></div>
        <div class="team-box"></div>
      </div>
      <div class="bottom-row">
        <span class="text-container"></span>
      </div>
      <div class="third-row">
        <span class="timestamp"></span>
      </div>
    </li>
  </template>
  <script src="script.js"></script>
</body>
</html>