<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Telop Operator</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; gap: 40px; }
        .panel { flex: 1; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        button { cursor: pointer; margin-right: 5px; }
        tr.answered { background-color: #e0e0e0; color: #888; }
        tr.disabled { text-decoration: line-through; color: #999; }
        #add-term-form { display: flex; gap: 10px; margin-top: 10px; }
        #add-term-form input { padding: 5px; }
        tr.now-displaying { background-color: #d4edda; /* 明るい緑色 */ font-weight: bold; }
    </style>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
    </script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>

    <div class="panel" id="questions-panel">
        <h1>テロップ操作パネル</h1>
        <button onclick="fetchQuestions()">質問リストを更新</button>
        <button onclick="clearTelop()">テロップを消去</button>
        <table id="questions-table">
            <thead>
                <tr>
                    <th>ラジオネーム</th>
                    <th>質問・お悩み</th>
                    <th>ステータス</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="panel" id="dictionary-panel">
        <h2>ルビ辞書管理</h2>
        <button onclick="fetchDictionary()">辞書を更新</button>
        <form id="add-term-form" onsubmit="addTerm(event)">
            <input type="text" id="new-term" placeholder="単語" required>
            <input type="text" id="new-ruby" placeholder="ルビ" required>
            <button type="submit">追加</button>
        </form>
        <table id="dictionary-table">
            <thead>
                <tr>
                    <th>単語</th>
                    <th>ルビ</th>
                    <th>状態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script type="module">
        // ▼▼▼ Firebaseの初期化処理を追加 ▼▼▼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // headに貼り付けたconfig情報をここにも記述
        const firebaseConfig = {
            apiKey: "AIzaSyBh54ZKsM6uNph61QrP-Ypu7bzU_PHbNcY",
            authDomain: "subtitle-output-system-9bc14.firebaseapp.com",
            databaseURL: "https://subtitle-output-system-9bc14-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "subtitle-output-system-9bc14",
            storageBucket: "subtitle-output-system-9bc14.firebasestorage.app",
            messagingSenderId: "378400426909",
            appId: "1:378400426909:web:f1549aad61e3f7aacebd74"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const telopRef = ref(database, 'currentTelop'); // データベース内の 'currentTelop' という場所を参照

        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxYtklsVbr2OmtaMISPMw0x2u0shjiUdwkym2oTZW7Xk14pcWxXG1lTcVC2GZAzjobapQ/exec'; 
        
        // --- 要素の取得 ---
        const questionsTableBody = document.querySelector('#questions-table tbody');
        const dictionaryTableBody = document.querySelector('#dictionary-table tbody');
        const newTermInput = document.getElementById('new-term');
        const newRubyInput = document.getElementById('new-ruby');

        // --- 質問関連の関数 ---
        async function fetchQuestions() {
            // Firebaseから現在のテロップ情報を一度だけ取得
            const snapshot = await get(telopRef);
            const currentTelop = snapshot.val();
        
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=answer`);
                const result = await response.json();
                if (result.success) {
                    questionsTableBody.innerHTML = '';
                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        if (item['回答済'] === true) { tr.classList.add('answered'); }
                        if (currentTelop && currentTelop.name === item['ラジオネーム'] && currentTelop.question === item['質問・お悩み']) {
                            tr.classList.add('now-displaying');
                        }
                        const encodedQuestion = btoa(unescape(encodeURIComponent(item['質問・お悩み'])));
                        
                        // 「選択中」と「回答済」のカラム表示を追加
                        const statusText = item['選択中'] === true ? '表示中' : (item['回答済'] === true ? '回答済' : '未回答');
        
                        tr.innerHTML = `
                            <td>${escapeHtml(item['ラジオネーム'])}</td>
                            <td>${escapeHtml(item['質問・お悩み'])}</td>
                            <td>${statusText}</td>
                            <td>
                                <button onclick="displayTelop('${item['UID']}', '${escapeHtml(item['ラジオネーム'])}', '${encodedQuestion}')">表示</button>
                                <button onclick="updateStatus('${item['UID']}', true)">回答済にする</button>
                                <button onclick="editQuestion('${item['UID']}', '${encodedQuestion}')">編集</button>
                            </td>
                        `;
                        questionsTableBody.appendChild(tr);
                    });
                } else {
                    console.error('データの取得に失敗しました: ' + result.error);
                }
            } catch (error) {
                console.error('通信エラーが発生しました: ' + error.message);
            }
        }

        async function displayTelop(uid, name, encodedQuestion) {
            const question = decodeURIComponent(escape(atob(encodedQuestion)));
            const telopData = { name: name, question: question };
            try {
                // 先にGASに「選択中」ステータスを更新するリクエストを送る
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateSelectingStatus', uid: uid })
                });
        
                // localStorage.setItem の代わりにFirebaseに書き込む
                await set(telopRef, telopData); 
                
                fetchQuestions();
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        async function editQuestion(uid, encodedCurrentText) {
            const currentText = decodeURIComponent(escape(atob(encodedCurrentText)));
            const newText = prompt("質問内容を編集してください：", currentText);

            // promptでキャンセルされた場合や、内容が変更されなかった場合は何もしない
            if (newText === null || newText.trim() === currentText.trim()) {
                return;
            }

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'editQuestion',
                        uid: uid,
                        newText: newText.trim()
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('質問を更新しました。');
                    fetchQuestions(); // リストを再読み込みして変更を反映
                } else {
                    alert('更新に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        async function clearTelop() {
            try {
                // UID: -1 を送ることで、GAS側で全てのフラグをクリアさせる
                await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'updateSelectingStatus', uid: -1 })
                });
                // localStorage.removeItem の代わりにFirebaseから削除する
                await remove(telopRef);
                fetchQuestions();
            } catch(error) {
                alert('ステータスのクリア中にエラーが発生しました: ' + error.message);
            }
        }

        async function updateStatus(uid, status) {
            if (!confirm('ステータスを「回答済」に変更しますか？')) return;
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'updateStatus', uid: uid, status: status })
                });
                const result = await response.json();
                if (result.success) {
                    alert('ステータスを更新しました。');
                    fetchQuestions();
                } else {
                    alert('更新に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラーが発生しました: ' + error.message);
            }
        }

        // --- 辞書関連の関数 ---
        async function fetchDictionary() {
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=dictionary`);
                const result = await response.json();
                if (result.success) {
                    dictionaryTableBody.innerHTML = '';
                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        if (!item.enabled) {
                            tr.classList.add('disabled');
                        }
                        tr.innerHTML = `
                            <td>${escapeHtml(item.term)}</td>
                            <td>${escapeHtml(item.ruby)}</td>
                            <td>${item.enabled ? '有効' : '無効'}</td>
                            <td>
                                <button onclick="toggleTerm('${escapeHtml(item.term)}', ${!item.enabled})">${item.enabled ? '無効にする' : '有効にする'}</button>
                                <button onclick="deleteTerm('${escapeHtml(item.term)}')">削除</button>
                            </td>
                        `;
                        dictionaryTableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                alert('辞書の取得に失敗: ' + error.message);
            }
        }

        async function addTerm(event) {
            event.preventDefault();
            const term = newTermInput.value.trim();
            const ruby = newRubyInput.value.trim();
            if (!term || !ruby) return;

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'addTerm', term: term, ruby: ruby })
                });
                const result = await response.json();
                if (result.success) {
                    newTermInput.value = '';
                    newRubyInput.value = '';
                    fetchDictionary();
                } else {
                    alert('追加失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        async function deleteTerm(term) {
            if (!confirm(`「${term}」を辞書から削除しますか？`)) return;
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteTerm', term: term })
                });
                const result = await response.json();
                if (result.success) {
                    fetchDictionary();
                } else {
                    alert('削除失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        async function toggleTerm(term, newStatus) {
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'toggleTerm', term: term, enabled: newStatus })
                });
                const result = await response.json();
                if (result.success) {
                    fetchDictionary();
                } else {
                    alert('状態の更新失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        // --- 共通関数 & 初期化処理 ---
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        window.displayTelop = displayTelop;
        window.clearTelop = clearTelop;
        window.updateStatus = updateStatus;
        window.editQuestion = editQuestion;
        window.fetchQuestions = fetchQuestions;
        window.fetchDictionary = fetchDictionary;
        window.addTerm = addTerm;
        window.toggleTerm = toggleTerm;
        window.deleteTerm = deleteTerm;
        
        fetchQuestions();
        fetchDictionary();
        setInterval(fetchQuestions, 30000); // 30000ミリ秒 = 30秒
    </script>
</body>
</html>
