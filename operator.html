<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Telop Operator</title>
    <style>
        body { font-family: sans-serif; padding: 20px; display: flex; gap: 40px; }
        .panel { flex: 1; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        button { cursor: pointer; margin-right: 5px; }
        tr.answered { background-color: #e0e0e0; color: #888; }
        tr.disabled { text-decoration: line-through; color: #999; }
        #add-term-form { display: flex; gap: 10px; margin-top: 10px; }
        #add-term-form input { padding: 5px; }
        tr.now-displaying { background-color: #d4edda; /* 明るい緑色 */ font-weight: bold; }
    </style>
</head>
<body>

    <div class="panel" id="questions-panel">
        <h1>テロップ操作パネル</h1>
        <button onclick="fetchQuestions()">質問リストを更新</button>
        <button onclick="clearTelop()">テロップを消去</button>
        <table id="questions-table">
            <thead>
                <tr>
                    <th>ラジオネーム</th>
                    <th>質問・お悩み</th>
                    <th>ステータス</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="panel" id="dictionary-panel">
        <h2>ルビ辞書管理</h2>
        <button onclick="fetchDictionary()">辞書を更新</button>
        <form id="add-term-form" onsubmit="addTerm(event)">
            <input type="text" id="new-term" placeholder="単語" required>
            <input type="text" id="new-ruby" placeholder="ルビ" required>
            <button type="submit">追加</button>
        </form>
        <table id="dictionary-table">
            <thead>
                <tr>
                    <th>単語</th>
                    <th>ルビ</th>
                    <th>状態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbxYtklsVbr2OmtaMISPMw0x2u0shjiUdwkym2oTZW7Xk14pcWxXG1lTcVC2GZAzjobapQ/exec'; 
        
        // --- 要素の取得 ---
        const questionsTableBody = document.querySelector('#questions-table tbody');
        const dictionaryTableBody = document.querySelector('#dictionary-table tbody');
        const newTermInput = document.getElementById('new-term');
        const newRubyInput = document.getElementById('new-ruby');

        // --- 質問関連の関数 ---
        async function fetchQuestions() {
            const currentTelopJSON = localStorage.getItem('currentTelop');
            const currentTelop = currentTelopJSON ? JSON.parse(currentTelopJSON) : null;
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=answer`);
                const result = await response.json();
                if (result.success) {
                    questionsTableBody.innerHTML = '';
                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        if (item['回答済'] === true) {
                            tr.classList.add('answered');
                        }
                        if (currentTelop && currentTelop.name === item['ラジオネーム'] && currentTelop.question === item['質問・お悩み']) {
                            tr.classList.add('now-displaying');
                        }
                        // ▼▼▼ 変更点：「編集」ボタンを追加 ▼▼▼
                        //
                        // Javacriptで文字列を扱う際、改行や特殊文字でエラーが起きやすいため、
                        // btoa()でBase64エンコードして渡し、関数側でatob()でデコードする方法をとっています。
                        const encodedQuestion = btoa(unescape(encodeURIComponent(item['質問・お悩み'])));

                        tr.innerHTML = `
                            <td>${escapeHtml(item['ラジオネーム'])}</td>
                            <td>${escapeHtml(item['質問・お悩み'])}</td>
                            <td>${item['回答済'] === true ? '回答済' : '未回答'}</td>
                            <td>
                                <button onclick="displayTelop('${escapeHtml(item['ラジオネーム'])}', '${encodedQuestion}')">表示</button>
                                <button onclick="updateStatus('${item['UID']}', true)">回答済にする</button>
                                <button onclick="editQuestion('${item['UID']}', '${encodedQuestion}')">編集</button>
                            </td>
                        `;
                        questionsTableBody.appendChild(tr);
                    });
                } else {
                    alert('データの取得に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラーが発生しました: ' + error.message);
            }
        }

        function displayTelop(name, question) {
            const telopData = { name: name, question: question };
            localStorage.setItem('currentTelop', JSON.stringify(telopData));
            alert(`「${name}」さんの質問を表示します。`);
            fetchQuestions();
        }
        
        async function editQuestion(uid, encodedCurrentText) {
            const currentText = decodeURIComponent(escape(atob(encodedCurrentText)));
            const newText = prompt("質問内容を編集してください：", currentText);

            // promptでキャンセルされた場合や、内容が変更されなかった場合は何もしない
            if (newText === null || newText.trim() === currentText.trim()) {
                return;
            }

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'editQuestion',
                        uid: uid,
                        newText: newText.trim()
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('質問を更新しました。');
                    fetchQuestions(); // リストを再読み込みして変更を反映
                } else {
                    alert('更新に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        function clearTelop() {
            localStorage.removeItem('currentTelop');
            alert('テロップを消去しました。');
            fetchQuestions();
        }

        async function updateStatus(uid, status) {
            if (!confirm('ステータスを「回答済」に変更しますか？')) return;
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'updateStatus', uid: uid, status: status })
                });
                const result = await response.json();
                if (result.success) {
                    alert('ステータスを更新しました。');
                    fetchQuestions();
                } else {
                    alert('更新に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラーが発生しました: ' + error.message);
            }
        }

        // --- 辞書関連の関数 ---
        async function fetchDictionary() {
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=dictionary`);
                const result = await response.json();
                if (result.success) {
                    dictionaryTableBody.innerHTML = '';
                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        if (!item.enabled) {
                            tr.classList.add('disabled');
                        }
                        tr.innerHTML = `
                            <td>${escapeHtml(item.term)}</td>
                            <td>${escapeHtml(item.ruby)}</td>
                            <td>${item.enabled ? '有効' : '無効'}</td>
                            <td>
                                <button onclick="toggleTerm('${escapeHtml(item.term)}', ${!item.enabled})">${item.enabled ? '無効にする' : '有効にする'}</button>
                                <button onclick="deleteTerm('${escapeHtml(item.term)}')">削除</button>
                            </td>
                        `;
                        dictionaryTableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                alert('辞書の取得に失敗: ' + error.message);
            }
        }

        async function addTerm(event) {
            event.preventDefault();
            const term = newTermInput.value.trim();
            const ruby = newRubyInput.value.trim();
            if (!term || !ruby) return;

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'addTerm', term: term, ruby: ruby })
                });
                const result = await response.json();
                if (result.success) {
                    newTermInput.value = '';
                    newRubyInput.value = '';
                    fetchDictionary();
                } else {
                    alert('追加失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        async function deleteTerm(term) {
            if (!confirm(`「${term}」を辞書から削除しますか？`)) return;
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'deleteTerm', term: term })
                });
                const result = await response.json();
                if (result.success) {
                    fetchDictionary();
                } else {
                    alert('削除失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        async function toggleTerm(term, newStatus) {
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'toggleTerm', term: term, enabled: newStatus })
                });
                const result = await response.json();
                if (result.success) {
                    fetchDictionary();
                } else {
                    alert('状態の更新失敗: ' + result.error);
                }
            } catch (error) {
                alert('通信エラー: ' + error.message);
            }
        }

        // --- 共通関数 & 初期化処理 ---
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        
        fetchQuestions();
        fetchDictionary();
        setInterval(fetchQuestions, 30000); // 30000ミリ秒 = 30秒
    </script>
</body>
</html>
