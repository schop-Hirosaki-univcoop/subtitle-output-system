<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Telop Operator</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        button { cursor: pointer; margin-right: 5px; }
        tr.answered { background-color: #e0e0e0; color: #888; } /* 回答済の行のスタイル */
    </style>
</head>
<body>
    <h1>テロップ操作パネル</h1>
    <button onclick="fetchQuestions()">質問リストを更新</button>
    <button onclick="clearTelop()">テロップを消去</button>
    <hr>
    <table id="questions-table">
        <thead>
            <tr>
                <th>ラジオネーム</th>
                <th>質問・お悩み</th>
                <th>ステータス</th> <th>操作</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script>
        const GAS_API_URL = 'ここにGASのウェブアプリURLを貼り付け'; 
        const tableBody = document.querySelector('#questions-table tbody');

        async function fetchQuestions() {
            try {
                const response = await fetch(`${GAS_API_URL}?sheet=answer`);
                const result = await response.json();

                if (result.success) {
                    tableBody.innerHTML = '';
                    result.data.forEach(item => {
                        const tr = document.createElement('tr');
                        
                        // ▼▼▼ 回答済フラグによってクラスを付与 ▼▼▼
                        if (item['回答済'] === true) {
                            tr.classList.add('answered');
                        }

                        // ▼▼▼ テーブルの列構成を変更 ▼▼▼
                        tr.innerHTML = `
                            <td>${escapeHtml(item['ラジオネーム'])}</td>
                            <td>${escapeHtml(item['質問・お悩み'])}</td>
                            <td>${item['回答済'] === true ? '回答済' : '未回答'}</td>
                            <td>
                                <button onclick="displayTelop('${item['ラジオネーム']}', '${item['質問・お悩み']}')">表示</button>
                                <button onclick="updateStatus('${item['UID']}', true)">回答済にする</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                } else {
                    alert('データの取得に失敗しました: ' + result.error);
                }
            } catch (error) {
                alert('通信エラーが発生しました: ' + error.message);
            }
        }

        function displayTelop(name, question) {
            const telopData = { name: name, question: question };
            localStorage.setItem('currentTelop', JSON.stringify(telopData));
            alert(`「${name}」さんの質問を表示します。`);
        }

        function clearTelop() {
            localStorage.removeItem('currentTelop');
            alert('テロップを消去しました。');
        }

        // ▼▼▼ 追加：ステータスを更新する関数 ▼▼▼
        async function updateStatus(uid, status) {
            if (!confirm('ステータスを「回答済」に変更しますか？')) return;

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // CORS対策で必要になる場合がある
                    },
                    body: JSON.stringify({
                        action: 'updateStatus',
                        uid: uid,
                        status: status
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ステータスを更新しました。');
                    fetchQuestions(); // テーブルを再読み込みして表示を更新
                } else {
                    alert('更新に失敗しました: ' + result.error);
                }

            } catch (error) {
                alert('通信エラーが発生しました: ' + error.message);
            }
        }
        
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        fetchQuestions();
    </script>
</body>
</html>
