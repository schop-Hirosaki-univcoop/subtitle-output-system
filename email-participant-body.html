<?
  var bodyCtx = typeof context !== 'undefined' && context ? context : {};
  var bodySubjectEventNameMatch = bodyCtx.subject ? String(bodyCtx.subject).match(/【([^】]+)】/) : null;
  var bodySubjectEventName = bodySubjectEventNameMatch ? bodySubjectEventNameMatch[1].trim() : '';
  var eventName =
    bodyCtx.resolvedEventName ||
    bodyCtx.eventName ||
    bodyCtx.eventLabel ||
    bodyCtx.eventId ||
    bodySubjectEventName ||
    'イベント';
  var highlightLabel =
    bodyCtx.resolvedScheduleLabel ||
    bodyCtx.scheduleRangeLabel ||
    bodyCtx.scheduleLabel ||
    '';
  var highlightDate = bodyCtx.scheduleDateDisplay || '';
  var highlightTime = bodyCtx.scheduleTimeDisplay || '';
  var fallbackHighlight = !highlightDate && !highlightTime ? highlightLabel : '';
  var contactUrl = bodyCtx.contactLinkUrl || '';
  var contactLabel = bodyCtx.contactLinkLabel || '';
?>
<div class="mail-container">
  <? if (bodyCtx.mode !== 'web' && bodyCtx.webViewUrl) { ?>
    <div class="mail-browser-link"><a href="<?= bodyCtx.webViewUrl ?>" target="_blank" rel="noopener">ブラウザで表示する</a></div>
  <? } ?>
  <div class="mail-card">
    <header class="mail-header">
      <? if (bodyCtx.tagline) { ?>
        <p class="mail-header__tagline"><?= bodyCtx.tagline ?></p>
      <? } ?>
      <h1 class="mail-header__title"><?= eventName ?> ご参加案内</h1>
      <? if (highlightLabel && (highlightDate || highlightTime)) { ?>
        <p class="mail-header__subtitle"><?= highlightLabel ?></p>
      <? } else if (highlightLabel) { ?>
        <p class="mail-header__subtitle"><?= highlightLabel ?></p>
      <? } ?>
    </header>

    <section class="mail-section mail-section--intro">
      <? if (bodyCtx.participantName) { ?>
        <p class="mail-greeting"><?= bodyCtx.participantName ?> 様</p>
      <? } ?>
      <p class="mail-intro">このたびは「<?= eventName ?>」へお申し込みいただきありがとうございます。以下の内容をご確認ください。</p>
    </section>

    <? if (highlightLabel || highlightDate || highlightTime || bodyCtx.arrivalNote) { ?>
      <section class="mail-section mail-section--highlight">
        <h2 class="mail-section__title">ご参加日時</h2>
        <div class="mail-highlight">
          <? if (highlightDate) { ?>
            <p class="mail-highlight__date"><?= highlightDate ?></p>
          <? } ?>
          <? if (highlightTime) { ?>
            <p class="mail-highlight__time"><?= highlightTime ?></p>
          <? } ?>
          <? if (fallbackHighlight) { ?>
            <p class="mail-highlight__label"><?= fallbackHighlight ?></p>
          <? } ?>
        </div>
        <? if (bodyCtx.arrivalNote) { ?>
          <p class="mail-section__note"><?= bodyCtx.arrivalNote ?></p>
        <? } ?>
      </section>
    <? } ?>

    <? if (bodyCtx.location) { ?>
      <section class="mail-section mail-section--location">
        <h2 class="mail-section__title">会場</h2>
        <p class="mail-section__text"><?= bodyCtx.location ?></p>
      </section>
    <? } ?>

    <? if (bodyCtx.guidance) { ?>
      <section class="mail-section mail-section--guidance">
        <h2 class="mail-section__title">当日の流れ</h2>
        <p class="mail-section__text"><?= bodyCtx.guidance ?></p>
      </section>
    <? } ?>

    <? if (bodyCtx.additionalHtml || bodyCtx.additionalText) { ?>
      <section class="mail-section mail-section--additional">
        <h2 class="mail-section__title">補足情報</h2>
        <? if (bodyCtx.additionalHtml) { ?>
          <div class="mail-section__text"><?!= bodyCtx.additionalHtml ?></div>
        <? } ?>
        <? if (bodyCtx.additionalText) { ?>
          <p class="mail-section__text"><?= bodyCtx.additionalText ?></p>
        <? } ?>
      </section>
    <? } ?>

    <? if ((contactUrl && contactLabel) || bodyCtx.contactEmail) { ?>
      <section class="mail-section mail-section--cta">
        <h2 class="mail-section__title">お問い合わせ</h2>
        <? if (contactUrl && contactLabel) { ?>
          <p class="mail-section__cta">
            <a href="<?= contactUrl ?>" class="mail-button" target="_blank" rel="noopener"><?= contactLabel ?></a>
          </p>
        <? } ?>
        <? if (bodyCtx.contactEmail) { ?>
          <p class="mail-section__text mail-section__text--muted">メール: <a href="mailto:<?= bodyCtx.contactEmail ?>"><?= bodyCtx.contactEmail ?></a></p>
        <? } ?>
      </section>
    <? } ?>

    <? if (bodyCtx.footerNote) { ?>
      <section class="mail-section mail-section--footer-note">
        <p class="mail-section__text"><?= bodyCtx.footerNote ?></p>
      </section>
    <? } ?>

    <footer class="mail-footer">
      <p class="mail-footer__signature"><?= bodyCtx.senderName || 'イベント運営チーム' ?></p>
    </footer>
  </div>
</div>

<? if (bodyCtx.mode === 'web' && bodyCtx.webViewUrl) { ?>
  <p class="mail-web-note">このページのURLは参加者向けメールにも記載されています。共有の際はリンクの取り扱いにご注意ください。</p>
<? } ?>
