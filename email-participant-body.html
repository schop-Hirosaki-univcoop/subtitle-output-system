<?
  const ctxBody =
    typeof ctx !== 'undefined'
      ? ctx
      : typeof context !== 'undefined' && context
        ? context
        : {};
  const existingResolvedEventName = typeof resolvedEventName !== 'undefined' ? resolvedEventName : '';
  const subjectEventNameMatch = ctxBody.subject ? String(ctxBody.subject).match(/【([^】]+)】/) : null;
  const subjectEventName = subjectEventNameMatch ? subjectEventNameMatch[1].trim() : '';
  const eventName =
    existingResolvedEventName ||
    ctxBody.eventName ||
    ctxBody.eventLabel ||
    ctxBody.eventId ||
    subjectEventName ||
    'イベント';
  const highlightLabel = ctxBody.scheduleRangeLabel || ctxBody.scheduleLabel || '';
  const highlightDate = ctxBody.scheduleDateDisplay || '';
  const highlightTime = ctxBody.scheduleTimeDisplay || '';
  const fallbackHighlight = !highlightDate && !highlightTime ? highlightLabel : '';
  const contactUrl = ctxBody.contactLinkUrl || '';
  const contactLabel = ctxBody.contactLinkLabel || '';
?>
<div class="mail-container">
  <? if (ctxBody.mode !== 'web' && ctxBody.webViewUrl) { ?>
    <div class="mail-browser-link"><a href="<?= ctxBody.webViewUrl ?>" target="_blank" rel="noopener">ブラウザで表示する</a></div>
  <? } ?>
  <div class="mail-card">
    <header class="mail-header">
      <? if (ctxBody.tagline) { ?>
        <p class="mail-header__tagline"><?= ctxBody.tagline ?></p>
      <? } ?>
      <h1 class="mail-header__title"><?= eventName ?> ご参加案内</h1>
      <? if (highlightLabel && (highlightDate || highlightTime)) { ?>
        <p class="mail-header__subtitle"><?= highlightLabel ?></p>
      <? } else if (highlightLabel) { ?>
        <p class="mail-header__subtitle"><?= highlightLabel ?></p>
      <? } ?>
    </header>

    <section class="mail-section mail-section--intro">
      <? if (ctxBody.participantName) { ?>
        <p class="mail-greeting"><?= ctxBody.participantName ?> 様</p>
      <? } ?>
      <p class="mail-intro">このたびは「<?= eventName ?>」へお申し込みいただきありがとうございます。以下の内容をご確認ください。</p>
    </section>

    <? if (highlightLabel || highlightDate || highlightTime || ctxBody.arrivalNote) { ?>
      <section class="mail-section mail-section--highlight">
        <h2 class="mail-section__title">ご参加日時</h2>
        <div class="mail-highlight">
          <? if (highlightDate) { ?>
            <p class="mail-highlight__date"><?= highlightDate ?></p>
          <? } ?>
          <? if (highlightTime) { ?>
            <p class="mail-highlight__time"><?= highlightTime ?></p>
          <? } ?>
          <? if (fallbackHighlight) { ?>
            <p class="mail-highlight__label"><?= fallbackHighlight ?></p>
          <? } ?>
        </div>
        <? if (ctxBody.arrivalNote) { ?>
          <p class="mail-section__note"><?= ctxBody.arrivalNote ?></p>
        <? } ?>
      </section>
    <? } ?>

    <? if (ctxBody.location) { ?>
      <section class="mail-section mail-section--location">
        <h2 class="mail-section__title">会場</h2>
        <p class="mail-section__text"><?= ctxBody.location ?></p>
      </section>
    <? } ?>

    <? if (ctxBody.guidance) { ?>
      <section class="mail-section mail-section--guidance">
        <h2 class="mail-section__title">当日の流れ</h2>
        <p class="mail-section__text"><?= ctxBody.guidance ?></p>
      </section>
    <? } ?>

    <? if (ctxBody.additionalHtml || ctxBody.additionalText) { ?>
      <section class="mail-section mail-section--additional">
        <h2 class="mail-section__title">補足情報</h2>
        <? if (ctxBody.additionalHtml) { ?>
          <div class="mail-section__text"><?!= ctxBody.additionalHtml ?></div>
        <? } ?>
        <? if (ctxBody.additionalText) { ?>
          <p class="mail-section__text"><?= ctxBody.additionalText ?></p>
        <? } ?>
      </section>
    <? } ?>

    <? if ((contactUrl && contactLabel) || ctxBody.contactEmail) { ?>
      <section class="mail-section mail-section--cta">
        <h2 class="mail-section__title">お問い合わせ</h2>
        <? if (contactUrl && contactLabel) { ?>
          <p class="mail-section__cta">
            <a href="<?= contactUrl ?>" class="mail-button" target="_blank" rel="noopener"><?= contactLabel ?></a>
          </p>
        <? } ?>
        <? if (ctxBody.contactEmail) { ?>
          <p class="mail-section__text mail-section__text--muted">メール: <a href="mailto:<?= ctxBody.contactEmail ?>"><?= ctxBody.contactEmail ?></a></p>
        <? } ?>
      </section>
    <? } ?>

    <? if (ctxBody.footerNote) { ?>
      <section class="mail-section mail-section--footer-note">
        <p class="mail-section__text"><?= ctxBody.footerNote ?></p>
      </section>
    <? } ?>

    <footer class="mail-footer">
      <p class="mail-footer__signature"><?= ctxBody.senderName || 'イベント運営チーム' ?></p>
    </footer>
  </div>
</div>

<? if (ctxBody.mode === 'web' && ctxBody.webViewUrl) { ?>
  <p class="mail-web-note">このページのURLは参加者向けメールにも記載されています。共有の際はリンクの取り扱いにご注意ください。</p>
<? } ?>
