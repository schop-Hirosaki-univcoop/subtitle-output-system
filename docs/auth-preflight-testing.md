# 認証プリフライト導入時のテスト計画

## 1. 現行テスト対象範囲と未カバーの認証ケース
- 既存の自動テストは質問フォーム用ユーティリティと参加者トークン収集に限定され、文字列正規化・日付整形・提出ペイロード構築といったデータ整形ロジックのみを検証している。
- 認証フロー関連で未カバーの主要パス:
  - ログイン画面の `LoginPage`: ポップアップ認証、エラー表示、匿名リンク破棄などを管理しているが正常系・異常系ともにテストなし。
  - OAuth 資格情報を画面間で引き継ぐ `storeAuthTransfer`/`consumeAuthTransfer`/`clearAuthTransfer`: 例外復旧や入力検証を含むが未検証。
  - ディスプレイ画面: 匿名認証の強制、非匿名ユーザーのサインアウト、セッションのハートビート再開を制御するがテストなし。
  - オペレーター UI (`login`/`logout`/`handleAuthState`): ポップアップ認証、許可メールチェック、権限付与リトライを行うが自動テストがなく回帰検出が困難。
  - イベント管理 UI: `consumeAuthTransfer` で資格情報を復元し、`signInWithCredential` の委譲失敗を扱うが未カバー。
  - Apps Script 側の `validateOperatorAuth_`: 匿名拒否、ドメイン制限、メール検証といった認証ガードを実装するが回帰防止テストが存在しない。

## 2. プリフライト追加で想定されるユニット/E2Eテストと優先順位
| 優先度 | テスト種別 | 目的/観点 | 対象コード |
| --- | --- | --- | --- |
| 高 | ユニット | プリフライトで利用するトークン前提条件（存在・revoked・PERMISSION_DENIED 等）の分岐を検証し、メッセージと例外を保証 | `runAuthPreflight`, `normalizeCredentialPayload` |
| 高 | ユニット | 認証プリフライトで保存する資格情報の整合性と例外復旧（ストレージ利用不可、無効入力）を検証 | `storeAuthTransfer`, `consumeAuthTransfer`, `clearAuthTransfer` |
| 高 | E2E（ブラウザ） | プリフライト通過時に匿名ディスプレイが自動サインイン→セッション開始→ハートビート維持となるか、拒否時に再試行されるかを確認 | ディスプレイモジュール全体 |
| 高 | E2E（ブラウザ） | ログイン→プリフライト→イベント画面への遷移と、資格情報引き継ぎ失敗時のフォールバックを確認 | `LoginPage` とイベントアプリの認証再開処理 |
| 中 | ユニット | プリフライト後のオペレーター権限確保フロー（許可メール判定・`ensureAdmin` 呼び出し失敗時の扱い）を検証 | `OperatorApp.handleAuthState` の分岐群 |
| 中 | ユニット | 認証転送が空でもプリフライトキャッシュから資格情報を復元してサインインを再開できることを確認 | `EventAdminApp.tryResumeAuth`【F:scripts/events/app.js†L883-L930】 |
| 中 | サーバーサイド | プリフライトが Apps Script の認証ガード（匿名拒否・許可ドメイン・メール検証）を通過/拒否する条件を確認 | `validateOperatorAuth_` |
| 低 | ユニット | プリフライト後のフォームリセットや文言表示が期待通りか（ガード文言、バナー内容など）を検証 | `applyContext` とビュー更新ロジック |

## 3. 実装完了条件として必須とすべきテストセット
- ユニット: `runAuthPreflight` のプリフライト分岐網羅（成功・権限拒否・期限切れ・通信エラー）。
- ユニット: 認証引き継ぎユーティリティ 3 関数の正常系と各種失敗モード（ストレージ未利用・JSON 破損）。
- ユニット: イベント画面が `sos:authPreflightContext` から資格情報を補完するフォールバックの正常系と異常系。【F:scripts/events/app.js†L883-L930】
- E2E: 匿名ディスプレイがプリフライト結果に応じてセッションを開始/再試行し、非匿名サインインを拒否するシナリオ。
- E2E: ログイン画面→プリフライト→イベント画面遷移で資格情報引き継ぎが成功し、失敗時は UI がエラー表示・再入力を促すフロー。
- サーバーサイド: Apps Script の認証バリデーションがプリフライトで要求される条件（匿名拒否、許可ドメイン、メール検証）を満たす/満たさないケース。

このテストセットを既存のユーティリティテストと合わせて自動化することで、認証プリフライト導入時の回帰リスクを最小限に抑えられる。
