# 日程管理方式改善計画

## 背景
- 現状では `operatorPresence` でモードを管理しつつ、`display.html` でイベントごとのテロップ操作が有効な日程を別途保持している。
- 日程管理が分散していることで整合性が取りづらく、日程選択モーダルの表示条件やテロップ操作無効モードの扱いが複雑になっている。

## 目標
- 有効なテロップ操作日程の管理を `display.html` 側で一元化する。
- `operatorPresence` は各オペレーターがどの日程を選択しているかのみを保持する。
- テロップ操作なしモードの扱いを明確化し、モーダル表示の条件を整理する。
- 現在有効な日程を日程選択パネルに表示し、全員ログアウトでリセットする。

## 実装方針
1. **データ構造の整理**
   - `display.html` のイベント定義に「テロップ操作有効日程」を追加し、更新日時 (`updatedAt`) は日程選択時のみ更新する。
   - `operatorPresence` ドキュメントには選択日程 ID と `updatedAt` のみを保持し、モード情報は撤廃する。
2. **日程選択フローの変更**
   - オペレーターが日程を選択した際、`display.html` 管理の有効日程を更新しつつ `operatorPresence` の該当ユーザの選択日程を更新する。
   - 全員がログアウトまたはセッション切れした場合、有効日程を空に戻すリセット処理を実装する。
3. **モーダル表示ロジック**
   - `operatorPresence` の最新更新時刻 (`updatedAt`) と日程選択状況を参照し、以下の条件でモーダルを表示する:
     - `operatorPresence` が最新であること。
     - 複数の日程が存在すること。
     - 有効日程が空であること。
   - 日程が設定されている場合は、パネル上に現在の有効日程を表示する。
4. **テロップ操作なしモード**
   - 専用のフラグ（例: `skipTally`）を `operatorPresence` または別コレクションに追加し、フラグが立っているユーザはモーダルをスキップ。
   - フラグが立っている場合でも、テロップ操作以外の機能は利用可能とする。
5. **UI 表示の更新**
   - 日程選択パネルに現在のテロップ操作有効日程を表示する。
   - 初期状態および全員ログアウト後は空表示とする。
6. **テストと検証**
   - 複数ユーザでの選択同期、モーダル表示条件、テロップ操作なしモードの動作を検証する。

## 残課題
- テロップ操作なしモードのフラグをどこで管理するか、実装時に最適な保存場所を検討する。
- 全員ログアウト判定のタイミング（セッション切れ検知方法）を Firebase の Presence 機能と整合させる必要がある。

