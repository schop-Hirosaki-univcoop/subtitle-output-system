# OperatorApp 共有ストレージとフォールバックの説明

## 概要

このドキュメントは、オペレーターツールとシステムの他の部分を連携させる共有ストレージの一覧をまとめ、新しいシグナル（完了フラグなど）が存在しない場合にアプリケーションがレガシー処理パスにフォールバックする方法を記録しています。埋め込みハンドシェイクを拡張したり、新しい共有フィールドを追加する際の参考として使用してください。

## 1. 共有ストレージの一覧

### 1.1 ブラウザストレージ（オペレーターワークステーションごと）

| ストレージ        | キー                              | 生成者 / 消費者                                                                                  | 保存されるフィールド                                                       | 目的                                                                                                                                                                                                                                                                                                                 |
| ---------------- | --------------------------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `sessionStorage` | `sos:operatorAuthTransfer`         | `storeAuthTransfer` で生成、`consumeAuthTransfer` で消費（`scripts/shared/auth-transfer.js`） | `providerId`, `signInMethod`, `idToken`, `accessToken`, `timestamp`        | ナビゲーションステップ間でFirebase OAuth認証情報を一時的に保持し、オペレーター埋め込みが同じサインイン結果を再利用できるようにする。ペイロードが欠落している場合、イベント画面はプリフライトキャッシュから認証情報を再構築する。【F:scripts/shared/auth-transfer.js†L1-L96】【F:scripts/events/app.js†L883-L930】 |
| `localStorage`   | `telop-ops-dictionary-open`       | `applyInitialDictionaryState` と `toggleDictionaryDrawer`（`scripts/operator/dictionary.js`） | ブール値フラグ（`'0'` / `'1'` として保存）                                | ルビ辞書のドロワーを開いた状態で開始するか、折りたたんだ状態で開始するかを記憶する。【F:scripts/operator/constants.js†L1-L26】【F:scripts/operator/dictionary.js†L817-L856】                                                                                                                                          |
| `localStorage`   | `telop-ops-logs-open`             | `applyInitialLogsState` と `toggleLogsDrawer`（`scripts/operator/logs.js`）                      | ブール値フラグ（`'0'` / `'1'` として保存）                                | 画面がリロードされたときにオペレーター活動ログのドロワー状態を復元する。【F:scripts/operator/constants.js†L1-L26】【F:scripts/operator/logs.js†L67-L109】                                                                                                                                                           |
| `localStorage`   | `telop-ops-questions-subtab`      | `loadPreferredSubTab` と `persistSubTabPreference`（`scripts/operator/questions.js`）            | 正規化されたサブタブ識別子（`"all"`, `"normal"`, `"puq"`）                 | オペレーターが最後に使用したタブ（例：通常キュー vs. ピックアップ）に質問リストをフォーカスし続ける。【F:scripts/operator/constants.js†L1-L26】【F:scripts/operator/questions.js†L117-L134】                                                                                                                         |

### 1.2 計画中のプリフライトコンテキストペイロード

| ストレージ                              | キー（暫定）                  | 生成者 / 消費者                                                                                                            | 保存されるフィールド                                                                                                                                                              | 目的                                                                                                                                                                                                                                          |
| -------------------------------------- | ---------------------------- | ------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `sessionStorage`（プライマリ）          | `sos:authPreflightContext`   | Googleサインイン直後に `runAuthPreflight` で生成され、ブートストラップ時に `EventAdminApp` / `OperatorApp` で消費される | `{ version, checkedAt, uid, email, credential: { providerId, signInMethod, idToken, accessToken }, admin: { ensuredAt, sheetHash }, mirror: { syncedAt, questionCount } }` | ログイン時のプリフライト結果を共有し、後続の画面が検証済み認証情報を再利用し、冗長な `ensureAdmin` をスキップし、変更がない場合に初期ミラーを繰り返さないようにする。【F:scripts/shared/auth-preflight.js†L161-L245】 |
| `localStorage`（フォールバック）        | `sos:authPreflightContext`   | 上記と同じ                                                                                                                | プライマリストレージと同じペイロード                                                                                                                                                | `sessionStorage` が利用できない場合（例：厳格なブラウザ設定）に使用される。初期化時に可能な限り両方のストアに書き込み、後続の画面がナビゲーションを生き延びた方を読み取れるようにする。【F:scripts/shared/auth-preflight.js†L92-L101】           |
| Firebase Realtime Database（将来の拡張） | `operatorPreflight/<uid>`    | 将来的にマルチタブオペレーターをサポートする際にプリフライトジョブで生成され、埋め込みで機会的に消費される               | 最小限のサマリー `{ checkedAt, adminGranted, mirrorVersion }`                                                                                                               | ワークステーション間で調整するためのオプションのリモートキャッシュ。最初のイテレーションでは不要だが、将来の作業が新しいスキームを発明する代わりにこのドキュメントを拡張するように記録されている。                                                          |

### 1.3 Firebase Realtime Database（アプリ間で共有）

| ノード / パス                                                                                                | 主な生成者                      | 主な消費者                                                       | OperatorAppが依存する主要フィールド                                                                                                                                                                                       | 備考                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------------------------------------------------------------ | ------------------------------ | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `render/events/<event>/sessions/<uid>`（プライマリ）および `render/session`（レガシー、非推奨）                 | 表示デバイスクライアント         | OperatorApp `startDisplaySessionMonitor`                          | `status`, `expiresAt`, `sessionId`, `eventId`, `scheduleId`, `scheduleLabel`, ネストされた `assignment`（`eventId`, `scheduleId`, `scheduleLabel`, `lockedByUid`, `lockedByName`, `lockedAt`）                                   | 表示リンクがアクティブかどうか、画面がロックしているスケジュールを決定する。エントリが欠落していると、UIは表示が切断されたと報告する。新しいパスはイベントごとに複数のdisplay.htmlインスタンスをサポートする。レガシー `render/session` は後方互換性のために保持されているが、削除予定。【F:scripts/operator/app.js†L4475-L4661】 |
| `render/events/<event>/<schedule>/state`（プライマリ）および `render/state`（レガシー、非推奨）                 | 表示レンダラー                   | OperatorApp `refreshChannelSubscriptions`, `handleRenderUpdate`   | `phase`, `updatedAt`, `nowShowing` ペイロード（`name`, `question`, オプションの `uid`, `participantId`, `pickup`）                                                                                                             | OperatorAppはアクティブなイベントとスケジュールに基づいてスコープ付きチャンネルを購読する。eventId/scheduleIdが欠落している場合はレガシーパスにフォールバックする。レガシーパスは削除予定。【F:scripts/operator/firebase.js†L73-L76】【F:scripts/operator/display.js†L5-L178】                                                                                   |
| `render/events/<event>/<schedule>/nowShowing`（プライマリ）および `render/state/nowShowing`（レガシー、非推奨） | 選択をプッシュする際のOperatorApp | 表示レンダラー                                                     | `uid`, `participantId`, `name`, `question`, `pickup`, オプションの `sideTelopRight`                                                                                                                                           | パス選択はメインのレンダー状態ヘルパーと同じレガシー/モダンルールに従う。レガシーパスは削除予定。【F:scripts/operator/firebase.js†L78-L81】【F:scripts/operator/questions.js†L480-L507】                                                                                                                                              |
| `render/events/<event>/<schedule>/sideTelops`（プライマリ）および `render/state/sideTelops`（レガシー、非推奨） | OperatorApp                     | 表示レンダラー                                                     | `right.items`（文字列の配列）, `right.activeIndex`（数値）, `right.updatedAt`                                                                                                                                         | 表示用のサイドテロッププリセット。レガシーパスは削除予定。【F:scripts/operator/firebase.js†L83-L86】                                                                                                                                                                                                                                            |
| `questions/normal/<uid>` および `questions/pickup/<uid>`                                                      | バックオフィスミラーリングジョブ | OperatorApp `startQuestionsStream` / `applyQuestionsBranch`      | UIDでキー付けされたレコード。`name`, `question`, `genre`, `group`, `eventId`, `scheduleId`, `scheduleLabel`, `scheduleStart`, `scheduleEnd`, `participantId`, `ts` などのメタデータ、オプションの `type` と `pickup` フラグ | ローダーはブランチを `Map` にマージし、各エントリにフィルタリング用の派生スケジュールラベルを注釈する。【F:scripts/operator/app.js†L2644-L2701】【F:scripts/operator/app.js†L2734-L2785】                                                                                                                                                      |
| `questionStatus/<event>/<uid>`（プライマリ）および `questionStatus/<uid>`（レガシー、非推奨）                   | オペレーターアクション           | OperatorApp `startQuestionStatusStream` / `applyQuestionStatusSnapshot` | UIDごとのフラグ `answered`, `selecting`, `pickup`, `updatedAt`。イベントIDで整理される                                                                                                                                   | メインの質問マップと結合してインタラクティブなキュー状態を構築する。新しいパスはイベントごとにステータスを分離してより良い分離を実現する。レガシーグローバルパスは削除予定。【F:scripts/operator/app.js†L4253-L4266】                                                                                                                                     |
| `questionIntake/events` および `questionIntake/schedules`                                                   | インテークパイプライン           | OperatorApp `startScheduleMetadataStreams` / `rebuildScheduleMetadata`  | イベント `name`。スケジュール `label`, `date`, `startAt`, `endAt` が `<event>::<schedule>` でキー付けされる                                                                                                                | バナーとフィルターメニューに表示される正規のラベルと時間範囲を提供する。【F:scripts/operator/app.js†L2805-L2864】                                                                                                                                                                                                                         |
| `dictionary`                                                                                                 | オペレーター辞書エディターまたはシートインポート | OperatorApp `startDictionaryListener` / `applyDictionarySnapshot`   | `uid`, `term`, `ruby`, `enabled`, `updatedAt` を持つエントリ                                                                                                                                                                | オペレーターパネルと字幕レンダラーの間で共有され、全員が同じふりがな置換をレンダリングする。【F:scripts/operator/dictionary.js†L740-L788】                                                                                                                                                                                            |
| `signals/logs`                                                                                               | バックエンドトリガー             | OperatorApp `startLogsUpdateMonitor`                               | タイムスタンプ値（コンテンツは未使用、変更通知のみ）                                                                                                                                                               | バックオフィスツールが新しいエントリを追加したときにテキスト操作ログを再取得するための安価なシグナルとして使用される。【F:scripts/operator/logs.js†L111-L118】                                                                                                                                                                                                     |
| `operatorPresence/<event>/<sessionId>`                                                                       | オペレータークライアント         | OperatorApp プレゼンス同期ヘルパー                                 | プレゼンスエントリ（`scheduleKey`, `scheduleId`, `scheduleLabel`, `updatedAt` など）                                                                                                                                        | 完了フラグ設計の直接的な部分ではないが、エントリはチャンネル割り当てフォールバックフローと並行して実行されるスケジュール競合検出に供給される。【F:scripts/operator/firebase.js†L100-L120】                                                                                                                                             |
| `render/displayPresence/<uid>`                                                                               | 表示デバイスクライアント         | OperatorApp `startDisplayPresenceMonitor`                          | `sessionId`, `clientTimestamp`, `lastSeenAt`, `eventId`, `scheduleId`, `channelEventId`, `channelScheduleId`, `assignmentEventId`, `assignmentScheduleId`, `status`, `reason`, `updatedBy`, `version`                     | 表示デバイスのプレゼンスとチャンネル割り当てステータスを追跡する。【F:scripts/operator/app.js†L4668-L4674】                                                                                                                                                                                                                                                |

## 2. 完了フラグまたはプリフライトコンテキストが存在しない場合のフォールバック

埋め込みホストが完了フラグを公開しない場合（または表示セッションが新しいフィールドを省略している場合）、またはキャッシュされたプリフライトコンテキストが利用できない場合、OperatorAppは既に理解しているデータに段階的にフォールバックすることで動作を継続します：

1. **永続化されたまたはURLコンテキストが最初に適用される。** 構築中、アプリは `window.location.search` と埋め込みコンテキストを解析して `pageContext` を埋め、値を `state.activeEventId`, `state.activeScheduleId` および関連フィールドに書き込む（`applyContextToState`）。【F:scripts/operator/app.js†L410-L476】
2. **UIコンテキストは利用可能な入力から更新される。** 質問やメタデータが再読み込みされるたびに、`updateScheduleContext` は現在のページコンテキストを確認し、イベント/スケジュールのペアが見つからない場合、`render/events/<event>/sessions`（またはレガシー `render/session` をフォールバックとして）から取得した最新の表示 `assignment` を参照してから、バナーラベルとキャッシュされた選択キーを更新する。【F:scripts/operator/questions.js†L293-L414】
3. **プリフライトキャッシュのプローブはリアルタイムルックアップに先行する。** 埋め込みは `sessionStorage`/`localStorage` で `sos:authPreflightContext` をチェックする。存在し、新鮮な場合、キャッシュされた認証情報を再適用し、冗長な管理者プロビジョニングをスキップする。使用可能なプリフライトがない場合、ローダーはユーザーシートを通じてメンバーシップを検証し、`ensureAdmin` を呼び出し、リアルタイム購読を配線する前にRTDB `questions`, `questionStatus/<event>`, インテークメタデータブランチを読み込んで自己をハイドレートする。【F:scripts/shared/auth-preflight.js†L200-L289】【F:scripts/operator/app.js†L2382-L2448】
4. **アクティブチャンネルの解決は複数のフォールバックを使用する。** `getActiveChannel` は最初に明示的な `state.active*` フィールドをチェックし、次に派生した `state.currentSchedule` またはURL提供のスケジュールキーを試行して、新しいセッションデータがなくてもレガシー選択が利用可能になるようにする。【F:scripts/operator/app.js†L483-L503】
5. **レガシーレンダーエンドポイントは引き続き到達可能（非推奨）。** Firebaseヘルパーは欠落しているイベントIDを歴史的な `render/state` と `render/state/nowShowing` の場所に変換し、スコープ付きチャンネルが識別されない場合にアプリがグローバルチャンネルの読み書きを継続できるようにする。**注意：これらのレガシーパスは非推奨であり、将来のリファクタリングで削除される予定です。**【F:scripts/operator/firebase.js†L48-L70】【F:scripts/shared/channel-paths.js†L1-L112】
6. **購読は自動的に調整される。** `refreshChannelSubscriptions` は前のステップで選択されたチャンネルを再利用するため、オペレータープレビューと表示コントロールは、レガシーノードを含む、フォールバックが解決したパスに対して動作を継続する。【F:scripts/operator/app.js†L680-L706】

**重要**: レガシーフォールバックパス（`render/state`, `render/session`, `questionStatus/<uid>`）は後方互換性のために維持されていますが、削除予定です。新しいコードは常にイベントスコープパス（`render/events/<event>/<schedule>/...`, `render/events/<event>/sessions/<uid>`, `questionStatus/<event>/<uid>`）を使用する必要があります。

## 3. 後続作業の使用ガイダンス

- 新しいフィールドを追加する際は、上記のテーブルを共有キーの権威あるリストとして扱い、追加のアドホックストレージを発明する代わりにそれらを拡張してください。
- **イベントスコープパスを使用する**: 常にレガシーグローバルパスの代わりに新しいイベントスコープパス（`render/events/<event>/...`, `questionStatus/<event>/...`）を使用してください。レガシーパスは非推奨であり、削除される予定です。
- **イベントIDは必須**: 新しいパスには `eventId` パラメータが必要です。これらのパスにアクセスする前に、イベントコンテキストが利用可能であることを確認してください。
- §2で概説されたフォールバックフローを保持して、完了フラグがないデプロイメントが機能を継続できるようにする。新しいシグナルは、これらのヘルパーをバイパスするのではなく、それらの上にレイヤーする必要があります。
- 完了フラグを導入する際は、既存の `render/events/<event>/sessions/<uid>` ペイロードと一緒に保存することを検討し、同じ購読が割り当てと完了状態の両方を配信し、フォールバックを変更せずにフラグで新しい動作をゲートする。

## 4. 移行ステータスと非推奨通知

### 非推奨パス（削除予定）

以下のパスは後方互換性のために維持されていますが、将来のリファクタリングで削除される予定です：

- `render/state` → `render/events/<event>/<schedule>/state` を使用してください
- `render/state/nowShowing` → `render/events/<event>/<schedule>/nowShowing` を使用してください
- `render/state/sideTelops` → `render/events/<event>/<schedule>/sideTelops` を使用してください
- `render/session` → `render/events/<event>/sessions/<uid>` を使用してください
- `screens/sessions/<uid>` → `render/events/<event>/sessions/<uid>` を使用してください
- `questionStatus/<uid>` → `questionStatus/<event>/<uid>` を使用してください

詳細な移行ガイダンスについては、`docs/firebase-rules-refactoring-impact.md` を参照してください。
