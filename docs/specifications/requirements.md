# 要件定義書

## 1. システム概要

### 1.1 システム名

字幕出力システム（Subtitle Output System）

### 1.2 目的

イベント運営において、参加者からの質問をリアルタイムで収集し、テロップとして表示するための Web アプリケーションシステム。GL（グループリーダー）の応募管理機能も提供する。

### 1.3 対象ユーザー

- **参加者**: 質問を投稿するイベント参加者
- **オペレーター**: 質問を管理し、テロップを操作する運営スタッフ
- **ディスプレイ**: テロップを表示する画面

## 2. 機能要件

### 2.1 認証・認可機能

#### 2.1.1 オペレーター認証

- Google アカウントによる OAuth 認証を実装
- 管理者権限を持つアカウントのみアクセス可能
- 認証状態の保持と画面間での引き継ぎ
- プリフライト認証による権限チェック
- Google スプレッドシート連携による許可ユーザーリストの管理（users シート）

#### 2.1.2 ディスプレイ認証

- 匿名認証を使用
- 表示用セッション管理
- セッションのハートビート維持

#### 2.1.3 参加者アクセス

- トークンベースの認証
- メール経由で配布される専用 URL からのアクセス
- トークンの有効期限管理

### 2.2 イベント・日程管理機能

#### 2.2.1 イベント管理

- イベントの作成・編集・削除
- イベント名の設定
- イベント単位でのデータ管理

#### 2.2.2 日程（スケジュール）管理

- イベントに紐づく日程の作成・編集・削除
- 日程ラベル、日付、開始時刻、終了時刻の設定
- 会場情報の管理
- 参加者数の管理
- GL 募集の有効/無効の設定（練習用日程などで GL 募集を行わない場合に使用）

#### 2.2.3 スケジュールローテーション管理

- 複数日程での表示順序設定
- 表示時間（dwell time）の設定
- 自動ローテーション機能

### 2.3 参加者管理機能

#### 2.3.1 参加者情報管理

- 参加者の登録・編集・削除
- 手動での参加者追加機能（1 人ずつ追加可能なモーダル）
- 氏名、フリガナ、メールアドレス、電話番号の管理
- 班番号の割り当て
- 参加者の状態管理（キャンセル、移動など）

#### 2.3.2 参加者への専用リンク発行

- 質問フォームへのアクセストークン生成
- トークンの有効期限管理
- トークンの無効化（取り消し）
- メール送信機能（専用リンクを含む）

#### 2.3.3 参加者リスト表示

- 日程・イベント単位での参加者一覧表示
- 重複参加者の検出と表示
- 検索・フィルタリング機能

#### 2.3.4 CSV インポート・エクスポート

- 参加者情報の CSV インポート機能（参加者追加モーダル内に統合）
- CSV インポート時のモード選択機能（追記モードと置き換えモード）
  - 追記モード: 既存の参加者情報を保持し、CSV の参加者を追加
  - 置き換えモード: 既存の参加者情報を削除し、CSV の参加者のみを残す
- CSV テンプレートのダウンロード機能
- 参加者リストの CSV エクスポート機能
- 班番号の CSV インポート機能（班番号 CSV テンプレートのダウンロード含む）
- CSV データのバリデーションとエラー表示

### 2.4 質問投稿機能

#### 2.4.1 質問フォーム

- ラジオネーム入力（最大 20 文字）
- 質問本文入力（最大 60 文字）
- ジャンル選択（学び、活動、暮らし、食・スポット、移動・季節、その他）
- フォームバリデーション
- 送信完了のフィードバック

#### 2.4.2 質問データの保存

- Firebase Realtime Database への保存
- 質問 UID の自動生成
- タイムスタンプの記録
- トークンとの紐付け

#### 2.4.3 コンテキスト情報の表示

- イベント名の表示
- 日程情報の表示
- 参加者への案内メッセージ

### 2.5 質問管理機能

#### 2.5.1 質問リスト表示

- イベント・日程単位での質問一覧
- ジャンル別フィルタリング
- 回答済み/未回答のフィルタリング
- 選択中/未選択のフィルタリング

#### 2.5.2 質問の状態管理

- 回答済みフラグの設定
- 選択中フラグの設定
- 質問の削除

#### 2.5.3 Pick Up Question 機能

- 特別な質問の登録
- Pick Up Question の管理
- 通常質問からの Pick Up Question への変換

### 2.6 テロップ表示機能

#### 2.6.1 テロップ表示

- ラジオネームの表示
- 質問本文の表示（1 行 23 文字の制約）
- ジャンルの表示
- ルビ（振り仮名）の自動適用

#### 2.6.2 表示制御

- テロップの表示/非表示制御
- 表示アニメーション
- スムーズな切り替えアニメーション（FLIP アニメーション）
- サイドテロップ（左右）の表示

#### 2.6.3 表示状態の管理

- 現在表示中の質問の状態管理
- 表示フェーズの管理（hidden, showing, visible, hiding, error）
- 複数ディスプレイの同期

#### 2.6.4 サイドテロップ

- 左サイドテロップ（イベント名・日程情報）
- 右サイドテロップ（ステータスメッセージ）
- サイドテロップのプリセット管理

### 2.7 オペレーター操作機能

#### 2.7.1 テロップ操作パネル

- 質問の選択と表示
- 表示中の質問の非表示
- 質問の検索とフィルタリング
- キーボードショートカット対応

#### 2.7.2 ディスプレイ管理

- ディスプレイセッションの確認
- ディスプレイへの割り当て
- ディスプレイのロック機能

### 2.8 GL 応募管理機能

#### 2.8.1 GL 応募フォーム

- 氏名、フリガナ、メールアドレスの入力
- 学年、学部、学科の選択
- 学部・学科の階層構造対応
- 参加可能日程の選択（複数選択可）
- 備考欄の入力
- 個人情報取扱いへの同意

#### 2.8.2 GL リスト管理

- 応募者の一覧表示
- 班割りステータスの管理
- シフト可否の確認
- 応募者の編集・削除

#### 2.8.3 学部・学科設定

- 学部・学科の階層構造の定義
- 学部カタログの管理
- イベント別の学部・学科設定

### 2.9 ルビ辞書機能

#### 2.9.1 ルビ辞書の管理

- 語句とルビの登録・編集・削除
- 有効/無効の切り替え
- テロップ表示への即座反映

#### 2.9.2 ルビの自動適用

- 質問本文にルビ辞書を自動適用
- 最長一致による語句マッチング
- HTML ルビタグ（`<ruby>`）への変換

### 2.10 メール送信機能

#### 2.10.1 参加者向けメール送信

- 専用リンクを含むメール送信
- メールテンプレートの使用
  - 外枠テンプレート（`email-participant-shell.html`）と本文テンプレート（`email-participant-body.html`）の組み合わせ
  - メール送信モードと Web 表示プレビューモードの両方をサポート
  - Google Apps Script の HTML サービス構文を使用
- 一斉送信機能
- 送信履歴の記録（メール送信ログの記録）

#### 2.10.2 メール閲覧機能

- メールが正しく表示されない場合の閲覧用ページ
- メール本文の表示
- アクセストークンによる認証

### 2.11 ログ機能

#### 2.11.1 操作ログ

- オペレーターの操作履歴の記録
- ログの閲覧機能
- タイムスタンプ、ユーザー、アクション、詳細情報の記録

### 2.12 オペレーターチャット機能

#### 2.12.1 チャット機能

- オペレーター間でのリアルタイムチャット
- メッセージの送信・受信
- 未読メッセージ数の表示
- 既読管理（各オペレーターの最終既読メッセージ ID を記録）
- 返信機能（replyTo）

### 2.13 印刷機能

#### 2.13.1 参加者リスト印刷

- 参加者リストの印刷プレビュー表示
- 印刷設定（用紙サイズ、向き、余白など）
- 参加者リストの印刷

#### 2.13.2 スタッフリスト印刷

- スタッフリストの印刷プレビュー表示
- スタッフリストの印刷

### 2.14 バックアップ・復元機能

#### 2.14.1 データバックアップ

- Firebase Realtime Database のバックアップ取得
- バックアップデータのダウンロード

#### 2.14.2 データ復元

- バックアップデータからの復元
- 復元前の確認処理

### 2.15 参加者管理の高度な機能

#### 2.15.1 参加者の移動

- 参加者の日程間移動
- 移動元・移動先の記録

#### 2.15.2 参加者のキャンセル

- 参加者のキャンセル処理
- キャンセル状態の管理

### 2.16 ディスプレイロック機能

#### 2.16.1 ディスプレイのロック

- ディスプレイを特定の日程にロック
- ロック情報の記録（ロック時刻、ロックしたユーザー情報）
- ロック状態の確認

## 3. 非機能要件

### 3.1 パフォーマンス要件

- テロップ表示の応答性：リアルタイムでの表示切り替え（1 秒以内）
- 質問投稿の応答性：投稿から保存まで 1 秒以内
- 画面ロード時間：初期表示 3 秒以内

### 3.2 可用性要件

- システムの可用性：99%以上
- セッション維持機能（ハートビート）
- エラーハンドリングとリトライ機能

### 3.3 セキュリティ要件

- 認証・認可の厳格な実装
- トークンベースのアクセス制御
- Firebase Security Rules によるデータアクセス制御
- HTTPS 通信の使用

### 3.4 ユーザビリティ要件

- レスポンシブデザイン（モバイル・デスクトップ対応）
- キーボードショートカットの提供
- わかりやすいエラーメッセージ
- アクセシビリティ対応（ARIA 属性など）

### 3.5 保守性要件

- コードの可読性と保守性
- モジュール化された設計
- ログ機能による問題追跡
- ドキュメントの整備

## 4. 制約事項

### 4.1 技術的制約

- Firebase Realtime Database の使用
- ブラウザベースのアプリケーション（JavaScript/HTML/CSS）
- Google Apps Script の使用（メール送信など）

### 4.2 運用制約

- 管理者権限を持つアカウントのみがオペレーター機能にアクセス可能
- トークンによる一時的なアクセス制御
- ディスプレイは特定のイベント・日程に紐付け

### 4.3 データ制約

- ラジオネーム：最大 20 文字
- 質問本文：最大 60 文字
- トークンの有効期限管理

## 5. 用語定義

- **イベント**: 質問を受け付けるイベント単位
- **日程（スケジュール）**: イベント内の個別の実施日時
- **参加者**: 質問を投稿するイベント参加者
- **オペレーター**: システムを操作する運営スタッフ
- **ディスプレイ**: テロップを表示する画面
- **トークン**: 参加者への質問フォームアクセスを制御する識別子
- **GL**: グループリーダー（Group Leader）
- **UID**: 質問の一意識別子（Unique Identifier）
- **Pick Up Question**: 特別に選択された質問
- **プリフライト認証**: ログイン前に権限を確認する事前認証処理
- **ハートビート**: セッションの生存確認のための定期的な通信
- **ルビ**: 漢字に振られる読み仮名
- **セッション**: ユーザーの接続状態を管理する単位
- **質問キュー**: 送信された質問を処理するための待ち行列
- **ローテーション**: 複数の日程を順番に切り替える機能
